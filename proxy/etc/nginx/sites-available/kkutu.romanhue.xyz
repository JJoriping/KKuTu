server {
	listen 80;
	listen [::]:80;

	server_name kkutu.romanhue.xyz kkt.romanhue.xyz;

	root /var/www/kkutu/html;
	index index.php index.html index.htm;

	autoindex off;
	charset utf-8;
	access_log /var/log/nginx/kkutu.romanhue.xyz/access.log main;
	disable_symlinks off;

	set_real_ip_from   0.0.0.0/0; real_ip_header     X-Forwarded-For;

	location / {
		try_files $uri $uri/ $uri.json =404;
	}

    location /language {
      rewrite ^/language/(.*)$ /proxy.php?type=lang&path=$1 last;
    }

    location /dict {
      rewrite ^/dict/(.*)$ /proxy.php?type=dict&path=$1 last;
    }

    location /servers {
      rewrite ^/servers$ /proxy.php?type=server last;
    }

    location /login {
      rewrite ^/login(.*)$ /proxy.php?type=login&path=$1 last;
    }

    location /admin/ {
        satisfy any;
                    allow 127.0.0.1;
                    allow ::1;
                    allow 182.224.172.27;
                    deny all;

        auth_basic "Admin page";
        auth_basic_user_file /etc/nginx/.htpasswd;

        # pass PHP scripts to FastCGI server
        location ~ \.php$ {
            include snippets/fastcgi-php.conf;

            # With php-fpm (or other unix sockets):
            fastcgi_pass unix:/run/php/php7.3-fpm.sock;
        }
    
        location /admin/gwalli {
          rewrite ^/admin/gwalli(.*)$ /admin/gwalli.php?path=$1 last;
        }
    }

    error_page 401 /error.php?code=401;
    error_page 403 /error.php?code=403;
    error_page 404 /error.php?code=404;
    error_page 500 /error.php?code=500;
    error_page 502 =500 /502.html;
    error_page 503 /error.php?code=503;
    error_page 504 /error.php?code=504;

    # pass PHP scripts to FastCGI server
	location ~ \.php$ {
		include snippets/fastcgi-php.conf;
	
	#	# With php-fpm (or other unix sockets):
		fastcgi_pass unix:/run/php/php7.3-fpm.sock;
        fastcgi_param PHP_VALUE "auto_prepend_file=/var/www/rhfiles.tk/includes/logging.php";
	}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	location ~ /\.ht {
		deny all;
	}






    listen [::]:443 ssl; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/kkt.romanhue.xyz/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/kkt.romanhue.xyz/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}
