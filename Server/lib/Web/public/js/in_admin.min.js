/**
Rule the words! KKuTu Online
Copyright (C) 2017 JJoriping(op@jjo.kr)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see <http://www.gnu.org/licenses/>.
*/


!function(){function a(a,b,c){return $("<input>").attr("id",a).css("width",f[b]).val(c)}function b(b,c,d,e,f){return a("word-"+[b,c,d,e].join("-"),e,f)}function c(a,b,c){var e=["wa",a,b,c].join("-")+"-";return $("<td>").append($("<button>").attr("id",e+"u").css("float","left").html("▲").on("click",d)).append($("<button>").attr("id",e+"x").css("float","left").html("X").on("click",d)).append($("<button>").attr("id",e+"e").css("float","left").html("?").on("click",d)).append($("<button>").attr("id",e+"d").css("float","left").html("▼").on("click",d))}function d(a){var b,c=$(a.currentTarget).attr("id").slice(3).split("-"),d=c.pop(),f=$("#wr-"+c.join("-"));switch(d){case"u":a.shiftKey&&(e(f,f.prev().attr("id").slice(3)),e(f.prev(),c.join("-"))),f.prev().before(f);break;case"x":f.remove();break;case"e":(b=prompt("새 key"))&&e(f,b);break;case"d":a.shiftKey&&(e(f,f.next().attr("id").slice(3)),e(f.next(),c.join("-"))),f.next().after(f)}}function e(a,b){var c=a.attr("id").slice(3);a.attr("id","wr-"+b).children("td").first().html(b),a.find("*").each(function(a,d){var e=$(d);e.attr("id")&&-1!=e.attr("id").indexOf(c)&&e.attr("id",e.attr("id").replace(c,b))})}var f={y:50,t:50,g:100,l:200,m:600},g={};$(document).ready(function(){$("#db-ok").on("click",function(a){"~"==$("#db-theme").val().charAt()?($("#db-list").val(""),$.get("/gwalli/kkututheme?theme="+$("#db-theme").val().slice(1)+"&lang="+$("#db-lang").val(),function(a){$("#db-list").val(a.list.join("\n"))})):$.post("/gwalli/kkutudb",{pw:$("#db-password").val(),lang:$("#db-lang").val(),theme:$("#db-theme").val(),list:$("#db-list").val()},function(a){alert(a)})}),$("#injeong-go").on("click",function(b){$.get("/gwalli/injeong",function(b){var c,d=$("#injeong-data").empty();b.list.forEach(function(b){d.append(c=$("<tr>").attr("id",["ir",b._id.replace(/ /g,"-")].join("-"))),c.append($("<td>").append(a("ij-"+b._id+"-check","y").attr("type","checkbox"))).append($("<td>").append($("<a>").attr({target:"_blank",href:"https://namu.moe/w/"+encodeURI(b._id)}).html("이동"))).append($("<td>").append(a("ij-"+b._id+"-_id","l",b._id))).append($("<td>").append(a("ij-"+b._id+"-theme","g",b.theme))).append($("<td>").append(a("ij-"+b._id+"-writer","g",b.writer))).append($("<td>").append(a("ij-"+b._id+"-createdAt","g",b.createdAt)))})})}),$("#injeong-everything").on("click",function(a){$("#injeong-data input[type='checkbox']").prop("checked",!0)}),$("#injeong-nothing").on("click",function(a){$("#injeong-data input[type='checkbox']").prop("checked",!1)}),$("#injeong-apply").on("click",function(a){var b=[];$("#injeong-data tr:visible").each(function(a,c){var d=$(c).find("td>input");b.push({_origin:c.id.slice(3).replace(/-/g," "),_id:d.get(1).value,theme:d.get(2).value,ok:$(d.get(0)).is(":checked")})}),$.post("/gwalli/injeong",{list:JSON.stringify({list:b}),pw:$("#db-password").val()},function(a){alert(a)})}),$("#shop-go").on("click",function(b){$.get("/gwalli/shop/"+$("#shop-word").val(),function(b){var c,d,e=$("#shop-data").empty();b.goods.forEach(function(b){e.append(d=$("<tr>").attr("id",["gu",b._id].join("-"))),d.append($("<td>").append(a("si-"+b._id+"-_id","g",b._id))).append($("<td>").append(a("si-"+b._id+"-cost","y",b.cost))).append($("<td>").append(a("si-"+b._id+"-hit","y",b.hit))).append($("<td>").append(a("si-"+b._id+"-term","y",b.term))).append($("<td>").append(a("si-"+b._id+"-group","y",b.group))).append($("<td>").append(a("si-"+b._id+"-updatedAt","y",b.updatedAt))).append($("<td>").append(a("si-"+b._id+"-options","l",JSON.stringify(b.options||{})))).append($("<td>").append(a("si-"+b._id+"-name_ko_KR","l"))).append($("<td>").append(a("si-"+b._id+"-desc_ko_KR","l"))).append($("<td>").append(a("si-"+b._id+"-name_en_US","l"))).append($("<td>").append(a("si-"+b._id+"-desc_en_US","l")))}),b.desc.forEach(function(a){var b=a._id.replace("$","\\$");for(c in a)"_id"!=c&&$("#si-"+b+"-"+c).val(a[c])})})}),$("#shop-hide").on("click",function(a){$("#shop-data tr:not(.gu-new)").toggle()}),$("#shop-add").on("click",function(b){var c=prompt("식별자");c&&$("#shop-data").append($("<tr>").attr("id","gu-"+c).addClass("gu-new").append($("<td>").append(a("si-"+c+"-_id","g",c))).append($("<td>").append(a("si-"+c+"-cost","y"))).append($("<td>").append(a("si-"+c+"-hit","y"))).append($("<td>").append(a("si-"+c+"-term","y"))).append($("<td>").append(a("si-"+c+"-group","y"))).append($("<td>").append(a("si-"+c+"-updatedAt","y"))).append($("<td>").append(a("si-"+c+"-options","l","{}"))).append($("<td>").append(a("si-"+c+"-name_ko_KR","l"))).append($("<td>").append(a("si-"+c+"-desc_ko_KR","l"))).append($("<td>").append(a("si-"+c+"-name_en_US","l"))).append($("<td>").append(a("si-"+c+"-desc_en_US","l"))))}),$("#shop-apply").on("click",function(a){var b=[];$("#shop-data tr:visible").each(function(a,c){var d=$(c).find("td>input");b.push({_id:d.get(0).value,core:{cost:d.get(1).value,hit:d.get(2).value||0,term:d.get(3).value||0,group:d.get(4).value,updatedAt:d.get(5).value||(new Date).getTime(),options:d.get(6).value},text:{name_ko_KR:d.get(7).value,desc_ko_KR:d.get(8).value,name_en_US:d.get(9).value,desc_en_US:d.get(10).value}})}),$.post("/gwalli/shop",{list:JSON.stringify({list:b}),pw:$("#db-password").val()},function(a){alert(a)})}),$("#user-go").on("click",function(b){$.get("/gwalli/users?id="+$("#user-id").val()+"&name="+$("#user-nick").val(),function(b){var c,d=$("#user-data").empty();b.list.forEach(function(b){d.append(c=$("<tr>").attr("id",["ur",b._id].join("-"))),c.append($("<td>").append(a("ud-"+b._id+"-_id","g",b._id))).append($("<td>").append(a("ud-"+b._id+"-money","g",b.money))).append($("<td>").append(a("ud-"+b._id+"-kkutu","l",JSON.stringify(b.kkutu||{})))).append($("<td>").append(a("ud-"+b._id+"-box","l",JSON.stringify(b.box||{})))).append($("<td>").append(a("ud-"+b._id+"-equip","l",JSON.stringify(b.equip||{})))).append($("<td>").append(a("ud-"+b._id+"-exordial","g",b.exordial))).append($("<td>").append(a("ud-"+b._id+"-server","t",b.server))).append($("<td>").append(a("ud-"+b._id+"-lastLogin","t",b.lastLogin))).append($("<td>").append(a("ud-"+b._id+"-black","g",b.black))).append($("<td>").append(a("ud-"+b._id+"-blockedUntil","g",b.blockedUntil))).append($("<td>").append(a("ud-"+b._id+"-friends","g",JSON.stringify(b.friends||{}))))})})}),$("#user-apply").on("click",function(a){var b=[];$("#user-data tr:visible").each(function(a,c){var d=$(c).find("td>input");b.push({_id:d.get(0).value,money:d.get(1).value,kkutu:d.get(2).value,box:d.get(3).value,equip:d.get(4).value,exordial:d.get(5).value,server:d.get(6).value,lastLogin:d.get(7).value,black:d.get(8).value,blockedUntil:d.get(9).value,friends:d.get(10).value})}),$.post("/gwalli/users",{list:JSON.stringify({list:b}),pw:$("#db-password").val()},function(a){alert(a)})}),$("#gamsi-go").on("click",function(a){function b(){var a=e[c],b=$("#gamsi-"+a);$.get("/gwalli/gamsi?id="+a,function(c){if(!c)return b.html("(없는 사용자)"+a);b.html([c._id,c.title||"-","<a target='_blank' href='/?server="+c.server+"'>"+c.server+"</a>"].map(function(a){return"<td>"+a+"</td>"}))}),c=(c+1)%f}clearInterval(g._gamsi);var c,d=$("#gamsi-data").empty(),e=$("#gamsi-id").val().split(/,\s*/),f=e.length;for(c in e)d.append($("<tr>").attr("id","gamsi-"+e[c]).html("<td>("+e[c]+") 감시 시작</td>")),b();c=0,g._gamsi=setInterval(b,1e4)}),$("#db-go").on("click",function(a){$.get("/gwalli/kkutudb/"+$("#db-word").val()+"?lang="+$("#db-lang").val(),function(a){var d=$("#wd-data").empty(),e=a.type?a.type.split(","):[],f=a.theme?a.theme.split(","):[],g=a.mean?a.mean.split(/＂[0-9]+＂/).slice(1).map(function(a){return-1==a.indexOf("［")?[[a]]:a.split(/［[0-9]+］/).slice(1).map(function(a){return a.split(/（[0-9]+）/).slice(1)})}):[[[]]];$("#wd-flag").val(a.flag),g.forEach(function(a,g){a.forEach(function(a,h){var i,j=e.shift();a.forEach(function(a,e){i=f.shift(),d.append($("<tr>").attr("id",["wr",g,h,e].join("-")).append($("<td>").html([g,h,e].join("-"))).append($("<td>").append(b(g,h,e,"y",j))).append($("<td>").append(b(g,h,e,"t",i))).append($("<td>").append(b(g,h,e,"m",a))).append(c(g,h,e)))})})})})}),$("#word-add").on("click",function(a){var d=prompt("key (-로 구분)");d&&(d=d.split("-"),$("#wd-data").append($("<tr>").attr("id",["wr",d[0],d[1],d[2]].join("-")).append($("<td>").html([d[0],d[1],d[2]].join("-"))).append($("<td>").append(b(d[0],d[1],d[2],"y",""))).append($("<td>").append(b(d[0],d[1],d[2],"t",""))).append($("<td>").append(b(d[0],d[1],d[2],"m",""))).append(c(d[0],d[1],d[2]))))}),$("#db-apply").on("click",function(a){var b={_id:$("#db-word").val(),flag:$("#wd-flag").val(),type:[],theme:[],mean:[]},c=!1;$("#wd-data tr").each(function(a,d){var e=$(d),f=e.children("td").first().html().split("-"),g=f[0]+"-"+f[1],h={type:$("#word-"+[f[0],f[1],f[2],"y"].join("-")).val(),theme:$("#word-"+[f[0],f[1],f[2],"t"].join("-")).val(),mean:$("#word-"+[f[0],f[1],f[2],"m"].join("-")).val()};c!=g&&(b.type.push(h.type),c=g),b.theme.push(h.theme),b.mean[f[0]]||(b.mean[f[0]]=[]),b.mean[f[0]][f[1]]||(b.mean[f[0]][f[1]]=[]),b.mean[f[0]][f[1]][f[2]]=h.mean}),b.type=b.type.join(","),b.theme=b.theme.join(","),b.mean=b.mean.map(function(a,b){return"ko"==$("#db-lang").val()?"＂"+(b+1)+"＂"+a.map(function(a,b){return"［"+(b+1)+"］"+a.map(function(a,b){return"（"+(b+1)+"）"+a}).join("")}).join(""):"＂"+(b+1)+"＂"+a}).join(""),$.post("/gwalli/kkutudb/"+$("#db-word").val(),{pw:$("#db-password").val(),lang:$("#db-lang").val(),data:JSON.stringify(b)},function(a){alert(a)})}),$("#kpw-query").on("click",function(a){function b(a,b){return b.slice(0).sort(function(b,c){return c.hit-(a[c._id]||0)-b.hit+(a[b._id]||0)})}function c(a,b){var c,d=$("<table>"),e=0;return b.forEach(function(b,f){if(!(f>=30)){var g=a[b._id]||0,h=b.hit==c?e:f;g=b.hit-g,b.delta=g?"(+"+g+")":"-",d.append($("<tr>").append($("<td style='width: 20px; text-align: center; background-color: #EEEEEE;'>").html(h+1)).append($("<td style='width: 200px;'>").html(b._id)).append($("<td style='width: 40px;'>").html(b.hit)).append($("<td style='width: 40px;'>").html(b.delta))),e=h,c=b.hit}}),d}var d=["한국어 종합","한국어 최근","한국어 3글자","한국어 어인정","영어 종합"];$.get("/gwalli/kkutuhot",function(a){var e=$("#kpw-table").empty();a.data.splice(1,0,b(a.prev,a.data[0])),d.forEach(function(b,d){e.append($("<div>").append($("<h3>").html(b)).append(c(a.prev,a.data[d])))}),$("#kpw-html").html(e.html())})}),$("#kpw-flush").on("click",function(a){$.post("/gwalli/kkutuhot",{pw:$("#db-password").val()},function(a){alert(a)})})})}();