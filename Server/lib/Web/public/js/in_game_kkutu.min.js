(function(){/**
Rule the words! KKuTu Online
Copyright (C) 2017 JJoriping(op@jjo.kr)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see <http://www.gnu.org/licenses/>.
*/


var e,a,t,s,n,l,d,c,m,u,p=[null,"10000000","10001000","10010010","10011010","11011010","11011110","11011111","11111111"],g={profile:{title:L.null},data:{score:0}},f=30,h=[],v=new RegExp(["느으*[^가-힣]*금마?","니[^가-힣]*(엄|앰|엠)","(ㅄ|ㅅㅂ|ㅂㅅ)","미친(년|놈)?","(병|븅|빙)[^가-힣]*신","보[^가-힣]*지","(새|섀|쌔|썌)[^가-힣]*(기|끼)","섹[^가-힣]*스","(시|씨|쉬|쒸)이*입?[^가-힣]*(발|빨|벌|뻘|팔|펄)","십[^가-힣]*새","씹","(애|에)[^가-힣]*미","자[^가-힣]*지","존[^가-힣]*나","좆|죶","지랄","창[^가-힣]*(녀|년|놈)","fuck","sex"].join("|"),"g"),k={},_={},y={},w={Classic:{},Jaqwi:{},Crossword:{},Typing:{},Hunmin:{},Daneo:{},Sock:{}},C=!1,x=!!window.hasOwnProperty("AudioContext")&&new AudioContext,T=window.WebSocket,S=setInterval,j=setTimeout;function q(e){32==e.keyCode&&(c.chatBtn.trigger("click"),e.preventDefault())}function R(){var e=y._list.slice(y.chain),r=y.room.opts.proverb?1:5,o="",a=e[0].length;a>=20&&(o="18px"),a>=50&&(o="15px"),c.game.display.css("font-size",o),e[0]="<label style='color: #FFFF44;'>"+e[0]+"</label>",c.game.display.html(e.slice(0,r).join(" ")),c.game.chain.show().html(y.chain),$(".jjo-turn-time .graph-bar").width("100%").html(e.slice(r,2*r).join(" ")).css({"text-align":"center","background-color":"#70712D"})}function D(e){$(".jjo-turn-time .graph-bar").html(e+L.afterRun),e>0&&G(D,1e3,e-1)}function A(e){var r;for(r in e)$("#game-user-"+r+" .game-user-score").empty().append($("<div>").css({float:"none",color:"#4444FF","text-align":"center"}).html(e[r]+"<label style='font-size: 11px;'>"+L.kpm+"</label>"))}$(document).ready(function(){var r,o,i;for(y.PUBLIC="true"==$("#PUBLIC").html(),y.URL=$("#URL").html(),y.version=$("#version").html(),y.server=location.href.match(/\?.*server=(\d+)/)[1],y.shop={},y._okg=0,y._playTime=0,y._kd="",y._timers=[],y._obtain=[],y._wblock={},y._shut={},y.usersR={},h.push(Ve(1)),r=2;r<360;r++)h.push(h[r-2]+Ve(r));if(h[359]=1/0,h.push(1/0),c={loading:$("#Loading"),lobby:{userListTitle:$(".UserListBox .product-title"),userList:$(".UserListBox .product-body"),roomListTitle:$(".RoomListBox .product-title"),roomList:$(".RoomListBox .product-body"),createBanner:$("<div>").addClass("rooms-item rooms-create").append($("<div>").html(L.newRoom))},chat:$("#Chat"),chatLog:$("#chat-log-board"),talk:$("#Talk"),chatBtn:$("#ChatBtn"),menu:{help:$("#HelpBtn"),setting:$("#SettingBtn"),community:$("#CommunityBtn"),newRoom:$("#NewRoomBtn"),setRoom:$("#SetRoomBtn"),quickRoom:$("#QuickRoomBtn"),spectate:$("#SpectateBtn"),shop:$("#ShopBtn"),dict:$("#DictionaryBtn"),wordPlus:$("#WordPlusBtn"),invite:$("#InviteBtn"),practice:$("#PracticeBtn"),ready:$("#ReadyBtn"),start:$("#StartBtn"),exit:$("#ExitBtn"),notice:$("#NoticeBtn"),replay:$("#ReplayBtn"),leaderboard:$("#LeaderboardBtn")},dialog:{setting:$("#SettingDiag"),settingServer:$("#setting-server"),settingOK:$("#setting-ok"),community:$("#CommunityDiag"),commFriends:$("#comm-friends"),commFriendAdd:$("#comm-friend-add"),room:$("#RoomDiag"),roomOK:$("#room-ok"),quick:$("#QuickDiag"),quickOK:$("#quick-ok"),result:$("#ResultDiag"),resultOK:$("#result-ok"),resultSave:$("#result-save"),practice:$("#PracticeDiag"),practiceOK:$("#practice-ok"),dict:$("#DictionaryDiag"),dictInjeong:$("#dict-injeong"),dictSearch:$("#dict-search"),wordPlus:$("#WordPlusDiag"),wordPlusOK:$("#wp-ok"),invite:$("#InviteDiag"),inviteList:$(".invite-board"),inviteRobot:$("#invite-robot"),roomInfo:$("#RoomInfoDiag"),roomInfoJoin:$("#room-info-join"),profile:$("#ProfileDiag"),profileShut:$("#profile-shut"),profileHandover:$("#profile-handover"),profileKick:$("#profile-kick"),profileLevel:$("#profile-level"),profileDress:$("#profile-dress"),profileWhisper:$("#profile-whisper"),kickVote:$("#KickVoteDiag"),kickVoteY:$("#kick-vote-yes"),kickVoteN:$("#kick-vote-no"),purchase:$("#PurchaseDiag"),purchaseOK:$("#purchase-ok"),purchaseNO:$("#purchase-no"),replay:$("#ReplayDiag"),replayView:$("#replay-view"),leaderboard:$("#LeaderboardDiag"),lbTable:$("#ranking tbody"),lbPage:$("#lb-page"),lbNext:$("#lb-next"),lbMe:$("#lb-me"),lbPrev:$("#lb-prev"),dress:$("#DressDiag"),dressOK:$("#dress-ok"),charFactory:$("#CharFactoryDiag"),cfCompose:$("#cf-compose"),injPick:$("#InjPickDiag"),injPickAll:$("#injpick-all"),injPickNo:$("#injpick-no"),injPickOK:$("#injpick-ok"),chatLog:$("#ChatLogDiag"),obtain:$("#ObtainDiag"),obtainOK:$("#obtain-ok"),help:$("#HelpDiag")},box:{chat:$(".ChatBox"),userList:$(".UserListBox"),roomList:$(".RoomListBox"),shop:$(".ShopBox"),room:$(".RoomBox"),game:$(".GameBox"),me:$(".MeBox")},game:{display:$(".jjo-display"),hints:$(".GameBox .hints"),cwcmd:$(".GameBox .cwcmd"),bb:$(".GameBox .bb"),items:$(".GameBox .items"),chain:$(".GameBox .chain"),round:$(".rounds"),here:$(".game-input").hide(),hereText:$("#game-input"),history:$(".history"),roundBar:$(".jjo-round-time .graph-bar"),turnBar:$(".jjo-turn-time .graph-bar")},yell:$("#Yell").hide(),balloons:$("#Balloons")},null==T)return E(L.websocketUnsupport),void alert(L.websocketUnsupport);for(y._soundList=[{key:"k",value:"/media/kkutu/k.mp3"},{key:"lobby",value:"/media/kkutu/LobbyBGM.mp3"},{key:"jaqwi",value:"/media/kkutu/JaqwiBGM.mp3"},{key:"jaqwiF",value:"/media/kkutu/JaqwiFastBGM.mp3"},{key:"game_start",value:"/media/kkutu/game_start.mp3"},{key:"round_start",value:"/media/kkutu/round_start.mp3"},{key:"fail",value:"/media/kkutu/fail.mp3"},{key:"timeout",value:"/media/kkutu/timeout.mp3"},{key:"lvup",value:"/media/kkutu/lvup.mp3"},{key:"Al",value:"/media/kkutu/Al.mp3"},{key:"success",value:"/media/kkutu/success.mp3"},{key:"missing",value:"/media/kkutu/missing.mp3"},{key:"mission",value:"/media/kkutu/mission.mp3"},{key:"kung",value:"/media/kkutu/kung.mp3"},{key:"horr",value:"/media/kkutu/horr.mp3"}],r=0;r<=10;r++)y._soundList.push({key:"T"+r,value:"/media/kkutu/T"+r+".mp3"},{key:"K"+r,value:"/media/kkutu/K"+r+".mp3"},{key:"As"+r,value:"/media/kkutu/As"+r+".mp3"});for(r in o=y._soundList,i=function(){Ne(_)},y._lsRemain=o.length,o.forEach(function(e){!function(e,r,o){var a=new XMLHttpRequest;function t(o){k[e]=new s(r),i()}function i(){0==--y._lsRemain?o&&o():E(L.loadRemain+y._lsRemain)}function s(e){var r=this;this.audio=new Audio(e),this.audio.load(),this.start=function(){r.audio.play()},this.stop=function(){r.audio.currentTime=0,r.audio.pause()}}a.open("GET",r),a.responseType="arraybuffer",a.onload=function(r){x?x.decodeAudioData(r.target.response,function(r){k[e]=r,i()},t):t()},a.send()}(e.key,e.value,i)}),delete y._soundList,a=$("#MOREMI_PART").html().split(","),t=$("#AVAIL_EQUIP").html().split(","),s=JSON.parse($("#RULE").html()),n=JSON.parse($("#OPTIONS").html()),e=Object.keys(s),(u="true"==$("#mobile").html())&&(f=200),y._timePercent=function(){return 100-(y._turnSound.audio?y._turnSound.audio.currentTime:x.currentTime-y._turnSound.startedAt)/y.turnTime*1e5+"%"},y.setRoom=function(e,r){var o="for-lobby"==Q();null==r?(delete y.rooms[e],o&&$("#room-"+e).remove()):(o&&!y.rooms[e]&&c.lobby.roomList.append($("<div>").attr("id","room-"+e)),y.rooms[e]=r,o&&$("#room-"+e).replaceWith(te(r)))},y.setUser=function(e,r){var o,a=Q(),t="for-lobby"==a||"for-master"==a;y._replay?m.users[e]=r:null==r?(delete y.users[e],t&&$("#users-item-"+e+",#invite-item-"+e).remove()):(t&&!y.users[e]&&(o=oe(r,"for-master"==a),"for-master"==a?c.dialog.inviteList.append(o):c.lobby.userList.append(o)),y.users[e]=r,t&&(o?$("#"+o.attr("id")).replaceWith(o):$("#"+("for-lobby"==a?"users-item-":"invite-item")+e).replaceWith(oe(r,"for-master"==a))))},$(document).on("paste",function(e){if(y.room&&y.room.gaming)return e.preventDefault(),!1}),c.talk.on("drop",function(e){if(y.room&&y.room.gaming)return e.preventDefault(),!1}),y.opts=$.cookie("kks"),y.opts&&F(JSON.parse(y.opts)),$(".dialog-head .dialog-title").on("mousedown",function(e){var r,o,a,t,i=$(e.currentTarget).parents(".dialog");$(".dialog-front").removeClass("dialog-front"),i.addClass("dialog-front"),r=i,o=e.pageX,a=e.pageY,t=r.position(),$(window).on("mousemove",function(e){var i=e.pageX-o,s=e.pageY-a;r.css("left",t.left+i),r.css("top",t.top+s)})}).on("mouseup",function(e){$(window).off("mousemove")}),c.chatBtn.on("click",function(e){var r=u&&c.game.here.is(":visible")?c.game.hereText.val():c.talk.val(),o={value:r};r&&("/"==o.value[0]?(o.cmd=o.value.split(" "),function(e){var r,o,a={"/ㄱ":L.cmd_r,"/청소":L.cmd_cls,"/ㄹ":L.cmd_f,"/ㄷ":L.cmd_e,"/ㄷㄷ":L.cmd_ee,"/무시":L.cmd_wb,"/차단":L.cmd_shut,"/id":L.cmd_id};switch(e[0].toLowerCase()){case"/ㄱ":case"/r":y.room&&(y.room.master==y.id?c.menu.start.trigger("click"):c.menu.ready.trigger("click"));break;case"/청소":case"/cls":$("#Chat").empty();break;case"/ㄹ":case"/f":N(c.dialog.chatLog),c.chatLog.scrollTop(999999999);break;case"/귓":case"/ㄷ":case"/e":V(e[1],e.slice(2).join(" "));break;case"/답":case"/ㄷㄷ":case"/ee":y._recentFrom?V(y._recentFrom,e.slice(1).join(" ")):sr(L.error_425);break;case"/무시":case"/wb":t=e[1],y._wblock.hasOwnProperty(t)?(delete y._wblock[t],sr(t+L.wnblocked)):(y._wblock[t]=!0,sr(t+L.wblocked));break;case"/차단":case"/shut":W(e.slice(1).join(" "));break;case"/id":if(e[1]){for(r in o=0,e[1]=e.slice(1).join(" "),y.users)(y.users[r].profile.title||y.users[r].profile.name)==e[1]&&sr("["+ ++o+"] "+r);o||sr(L.error_405)}else sr(L.myId+y.id);break;default:for(r in a)sr(a[r],r)}var t}(o.cmd)):((c.game.here.is(":visible")||y._relay)&&(o.relay=!0),P("talk",o)),y._whisper?(c.talk.val("/e "+y._whisper+" "),delete y._whisper):c.talk.val(""),c.game.hereText.val(""))}).hotkey(c.talk,13).hotkey(c.game.hereText,13),$("#cw-q-input").on("keydown",function(e){if(13==e.keyCode){var r=$(e.currentTarget),o=r.val(),a={relay:!0,data:y._sel,value:o};if(!o)return;P("talk",a),r.val("")}}).on("focusout",function(e){$(".cw-q-body").empty(),c.game.cwcmd.css("opacity",0)}),$("#room-limit").on("change",function(e){var r=$(e.currentTarget),o=r.val();o<2||o>8?r.css("color","#FF4444"):r.css("color","")}),$("#room-round").on("change",function(e){var r=$(e.currentTarget),o=r.val();o<1||o>10?r.css("color","#FF4444"):r.css("color","")}),c.game.here.on("click",function(e){u||c.talk.focus()}),c.talk.on("keyup",function(e){c.game.hereText.val(c.talk.val())}),$(window).on("beforeunload",function(e){if(y.room)return L.sureExit}),$(".result-me-gauge .graph-bar").addClass("result-me-before-bar"),$(".result-me-gauge").append($("<div>").addClass("graph-bar result-me-current-bar")).append($("<div>").addClass("graph-bar result-me-bonus-bar")),c.dialog)c.dialog[r].children(".dialog-head").hasClass("no-close")||c.dialog[r].children(".dialog-head").append($("<div>").addClass("closeBtn").on("click",function(e){$(e.currentTarget).parent().parent().hide()}).hotkey(!1,27));function p(e,r){var o,a;for(o in n)a=n[o].name.toLowerCase(),-1==e.indexOf(o)?$("#"+r+"-"+a+"-panel").hide():$("#"+r+"-"+a+"-panel").show()}function g(e){var r,o,a={};for(r in n)o=n[r].name.toLowerCase(),$("#"+e+"-"+o).is(":checked")&&(a[o]=!0);return a}function v(e,r,o,a){var t;if(!a){if(e.gaming)return!1;if(e.password)return!1;if(e.players.length>=e.limit)return!1}if(e.mode!=r)return!1;for(t in o)if(!e.opts[t])return!1;return!0}for(c.menu.help.on("click",function(e){$("#help-board").attr("src","/help"),N(c.dialog.help)}),c.menu.setting.on("click",function(e){N(c.dialog.setting)}),c.menu.community.on("click",function(e){if(y.guest)return hr(451);N(c.dialog.community)}),c.dialog.commFriendAdd.on("click",function(e){var r=prompt(L.friendAddNotice);if(r)return y.users[r]?void P("friendAdd",{target:r},!0):hr(450)}),c.menu.newRoom.on("click",function(e){var r;c.dialog.quick.hide(),y.typeRoom="enter",N(r=c.dialog.room),r.find(".dialog-title").html(L.newRoom)}),c.menu.setRoom.on("click",function(r){var o,a,t,i=s[e[y.room.mode]];for(a in y.typeRoom="setRoom",$("#room-title").val(y.room.title),$("#room-limit").val(y.room.limit),$("#room-mode").val(y.room.mode).trigger("change"),$("#room-round").val(y.room.round),$("#room-time").val(y.room.time/i.time),n)t=n[a].name.toLowerCase(),$("#room-"+t).attr("checked",y.room.opts[t]);y._injpick=y.room.opts.injpick,N(o=c.dialog.room),o.find(".dialog-title").html(L.setRoom)}),$("#quick-mode, #QuickDiag .game-option").on("change",function(r){var o,a,t=$("#quick-mode").val(),i=0;for(o in"quick-mode"==r.currentTarget.id&&$("#QuickDiag .game-option").prop("checked",!1),a=g("quick"),p(s[e[t]].opts,"quick"),y.rooms)v(y.rooms[o],t,a,!0)&&i++;$("#quick-status").html(L.quickStatus+" "+i)}),c.menu.quickRoom.on("click",function(e){c.dialog.room.hide(),N(c.dialog.quick),c.dialog.quick.is(":visible")&&($("#QuickDiag>.dialog-body").find("*").prop("disabled",!1),$("#quick-mode").trigger("change"),$("#quick-queue").html(""),c.dialog.quickOK.removeClass("searching").html(L.OK))}),c.dialog.quickOK.on("click",function(e){var r=$("#quick-mode").val(),o=g("quick");if("for-lobby"==Q()){if(c.dialog.quickOK.hasClass("searching"))return c.dialog.quick.hide(),a(),void c.menu.quickRoom.trigger("click");$("#QuickDiag>.dialog-body").find("*").prop("disabled",!0),c.dialog.quickOK.addClass("searching").html("<i class='fa fa-spinner fa-spin'></i> "+L.NO).prop("disabled",!1),y._quickn=0,y._quickT=I(a,1e3)}function a(){var e,a=[];if(c.dialog.quick.is(":visible")){for(e in $("#quick-queue").html(L.quickQueue+" "+ee(1e3*y._quickn++)),y.rooms)v(y.rooms[e],r,o)&&a.push(e);a.length&&(e=a[Math.floor(Math.random()*a.length)],y._preQuick=!0,$("#room-"+e).trigger("click"))}else clearTimeout(y._quickT)}}),$("#room-mode").on("change",function(r){var o=$("#room-mode").val(),a=s[e[o]];$("#game-mode-expl").html(L["modex"+o]),p(a.opts,"room"),y._injpick=[],-1!=a.opts.indexOf("ijp")?$("#room-injpick-panel").show():$("#room-injpick-panel").hide(),"Typing"==a.rule&&$("#room-round").val(3),$("#room-time").children("option").each(function(e,r){$(r).html(Number($(r).val())*a.time+L.SECOND)})}).trigger("change"),c.menu.spectate.on("click",function(e){c.menu.spectate.hasClass("toggled")?(P("form",{mode:"J"}),c.menu.spectate.removeClass("toggled")):(P("form",{mode:"S"}),c.menu.spectate.addClass("toggled"))}),c.menu.shop.on("click",function(e){var r;(y._shop=!y._shop)?((r=$("#shop-shelf")).html(L.LOADING),Ne(function(e){if(r.empty(),y.guest&&(e.error=423),e.error)return c.menu.shop.trigger("click"),hr(e.error);e.goods.sort(function(e,r){return r.updatedAt-e.updatedAt}).forEach(function(e,o,a){if(!(e.cost<0)){var t=mr(!1,e);r.append($("<div>").attr("id","goods_"+e._id).addClass("goods").append($("<div>").addClass("jt-image goods-image").css("background-image","url("+t+")")).append($("<div>").addClass("goods-title").html(dr(e._id))).append($("<div>").addClass("goods-cost").html(fr(e.cost)+L.ping)).append(Ee(e,!1)).on("click",Fe))}}),global.expl(r)}),$(".shop-type.selected").removeClass("selected"),$("#shop-type-all").addClass("selected"),c.menu.shop.addClass("toggled")):c.menu.shop.removeClass("toggled"),z()}),$(".shop-type").on("click",function(e){var r=$(e.currentTarget),o=r.attr("id").slice(10);$(".shop-type.selected").removeClass("selected"),r.addClass("selected"),function(e){var r,o,a,t=!0===e;t||(e=e.split(","));for(a in y.shop)(o=y.shop[a]).cost<0||(r=$("#goods_"+a).show(),t||-1==e.indexOf(o.group)&&r.hide())}("all"==o||r.attr("value"))}),c.menu.dict.on("click",function(e){N(c.dialog.dict)}),c.menu.wordPlus.on("click",function(e){N(c.dialog.wordPlus)}),c.menu.invite.on("click",function(e){N(c.dialog.invite),re(!0)}),c.menu.practice.on("click",function(r){s[e[y.room.mode]].ai?($("#PracticeDiag .dialog-title").html(L.practice),$("#ai-team").val(0).prop("disabled",!0),N(c.dialog.practice)):P("practice",{level:-1})}),c.menu.ready.on("click",function(e){P("ready")}),c.menu.start.on("click",function(e){P("start")}),c.menu.exit.on("click",function(e){if(y.room.gaming){if(!confirm(L.sureExit))return;!function(){y._spaced&&w.Typing.spaceOff();clearInterval(y._tTime),y._relay=!1}()}P("leave")}),c.menu.replay.on("click",function(e){y._replay&&Se(),N(c.dialog.replay),c.dialog.replayView.attr("disabled",!0),c.dialog.replay.is(":visible")&&$("#replay-file").trigger("change")}),c.menu.leaderboard.on("click",function(e){y._lbpage=0,c.dialog.leaderboard.is(":visible")?c.dialog.leaderboard.hide():$.get("/ranking",function(e){he(e),N(c.dialog.leaderboard)})}),c.dialog.lbPrev.on("click",function(e){$(e.currentTarget).attr("disabled",!0),$.get("/ranking?p="+(y._lbpage-1),function(e){he(e)})}),c.dialog.lbMe.on("click",function(e){$(e.currentTarget).attr("disabled",!0),$.get("/ranking?id="+y.id,function(e){he(e)})}),c.dialog.lbNext.on("click",function(e){$(e.currentTarget).attr("disabled",!0),$.get("/ranking?p="+(y._lbpage+1),function(e){he(e)})}),c.dialog.settingServer.on("click",function(e){location.href="/"}),c.dialog.settingOK.on("click",function(e){F({mb:$("#mute-bgm").is(":checked"),me:$("#mute-effect").is(":checked"),di:$("#deny-invite").is(":checked"),dw:$("#deny-whisper").is(":checked"),df:$("#deny-friend").is(":checked"),ar:$("#auto-ready").is(":checked"),su:$("#sort-user").is(":checked"),ow:$("#only-waiting").is(":checked"),ou:$("#only-unlock").is(":checked")}),$.cookie("kks",JSON.stringify(y.opts)),c.dialog.setting.hide()}),c.dialog.profileLevel.on("click",function(e){$("#PracticeDiag .dialog-title").html(L.robot),$("#ai-team").prop("disabled",!1),N(c.dialog.practice)}),c.dialog.practiceOK.on("click",function(e){var r=$("#practice-level").val(),o=$("#ai-team").val();c.dialog.practice.hide(),$("#PracticeDiag .dialog-title").html()==L.robot?P("setAI",{target:y._profiled,level:r,team:o}):P("practice",{level:r})}),c.dialog.roomOK.on("click",function(e){var r,o,a={injpick:y._injpick};for(r in n)a[o=n[r].name.toLowerCase()]=$("#room-"+o).is(":checked");P(y.typeRoom,{title:$("#room-title").val().trim()||$("#room-title").attr("placeholder").trim(),password:$("#room-pw").val(),limit:$("#room-limit").val(),mode:$("#room-mode").val(),round:$("#room-round").val(),time:$("#room-time").val(),opts:a}),c.dialog.room.hide()}),c.dialog.resultOK.on("click",function(e){1==y._resultPage&&y._resultRank?Me(y._resultRank[y.id]):(y.practicing&&(y.room.gaming=!0,P("leave")),y.resulting=!1,c.dialog.result.hide(),delete y._replay,delete y._resultRank,c.box.room.height(360),Xe("lobby"),ar(),z())}),c.dialog.resultSave.on("click",function(e){var r=new Date(m.time),o=new Blob([JSON.stringify(m)],{type:"text/plain"}),a=URL.createObjectURL(o),t="KKuTu"+r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate()+" "+r.getHours()+"-"+r.getMinutes()+"-"+r.getSeconds()+".kkt",i=$("<a>").attr({download:t,href:a}).on("click",function(e){i.remove()});$("#Jungle").append(i),i[0].click()}),c.dialog.dictInjeong.on("click",function(e){var r=$(e.currentTarget);r.is(":disabled")||$("#dict-theme").val()&&(r.prop("disabled",!0),$("#dict-output").html(L.searching),$.get("/injeong/"+$("#dict-input").val()+"?theme="+$("#dict-theme").val(),function(e){if(G(function(){r.prop("disabled",!1)},2e3),e.error)return $("#dict-output").html(e.error+": "+L["wpFail_"+e.error]);$("#dict-output").html(L.wpSuccess+"("+e.message+")")}))}),c.dialog.dictSearch.on("click",function(e){var r=$(e.currentTarget);r.is(":disabled")||(r.prop("disabled",!0),$("#dict-output").html(L.searching),H($("#dict-input").val(),function(e){if(G(function(){r.prop("disabled",!1)},500),e.error)return $("#dict-output").html(e.error+": "+L["wpFail_"+e.error]);$("#dict-output").html(Ue(e.word,e.mean,e.theme,e.type.split(",")))}))}).hotkey($("#dict-input"),13),c.dialog.wordPlusOK.on("click",function(e){var r;c.dialog.wordPlusOK.hasClass("searching")||(r=$("#wp-input").val())&&((r=r.replace(/[^a-z가-힣]/g,"")).length<2||($("#wp-input").val(""),$(e.currentTarget).addClass("searching").html("<i class='fa fa-spin fa-spinner'></i>"),P("wp",{value:r})))}).hotkey($("#wp-input"),13),c.dialog.inviteRobot.on("click",function(e){$e("AI")}),c.box.me.on("click",function(e){be(y.id)}),c.dialog.roomInfoJoin.on("click",function(e){c.dialog.roomInfo.hide(),or(y._roominfo)}),c.dialog.profileHandover.on("click",function(e){confirm(L.sureHandover)&&P("handover",{target:y._profiled})}),c.dialog.profileKick.on("click",function(e){P("kick",{robot:y.robots.hasOwnProperty(y._profiled),target:y._profiled})}),c.dialog.profileShut.on("click",function(e){var r=y.users[y._profiled];r&&W(r.profile.title||r.profile.name)}),c.dialog.profileWhisper.on("click",function(e){var r=y.users[y._profiled];c.talk.val("/e "+(r.profile.title||r.profile.name).replace(/\s/g,"")+" ").focus()}),c.dialog.profileDress.on("click",function(e){return y.guest?hr(421):y._gaming?hr(438):void(N(c.dialog.dress)&&$.get("/box",function(e){if(e.error)return hr(e.error);y.box=e,ue()}))}),c.dialog.dressOK.on("click",function(e){var r={};$(e.currentTarget).attr("disabled",!0),$("#dress-nickname").val()!==y.nickname&&(r.nickname=$("#dress-nickname").val()),$("#dress-exordial").val()!==y.exordial&&(r.exordial=$("#dress-exordial").val()),confirm(L.sureChangeNick)&&$.post("/profile",r,function(e){if(e.error)return hr(e.error);r.nickname&&(y.users[y.id].nickname=y.nickname=r.nickname,$("#account-info").text(r.nickname)),(r.exordial||""===r.exordial)&&(y.users[y.id].exordial=y.exordial=r.exordial),P("updateProfile",{id:y.id,nickname:y.nickname,exordial:y.exordial}),alert(`${r.nickname?r.exordial||""===r.exordial?L.nickChanged+y.nickname+L.changed+" "+L.exorChanged+y.exordial+L.changed:L.nickChanged+y.nickname+L.changed:L.exorChanged+y.exordial+L.changed}`),c.dialog.dressOK.attr("disabled",!1)}),c.dialog.dress.hide()}),$("#DressDiag .dress-type").on("click",function(e){var r=$(e.currentTarget),o=r.attr("id").slice(11);$(".dress-type.selected").removeClass("selected"),r.addClass("selected"),ge("all"==o||r.attr("value"))}),$("#dress-cf").on("click",function(e){if(y._gaming)return hr(438);N(c.dialog.charFactory)&&fe()}),c.dialog.cfCompose.on("click",function(e){if(!c.dialog.cfCompose.hasClass("cf-composable"))return hr(436);confirm(L.cfSureCompose)&&$.post("/cf",{tray:y._tray.join("|")},function(e){var r;if(e.error)return hr(e.error);for(r in P("refresh"),alert(L.cfComposed),y.users[y.id].money=e.money,y.box=e.box,e.gain)ur(e.gain[r]);ue(y._avGroup),Z(),fe()})}),$("#room-injeong-pick").on("click",function(r){var o,a=s[e[$("#room-mode").val()]];for(o in $("#injpick-list>div").hide(),"ko"==a.lang?(y._ijkey="#ko-pick-",$("#ko-pick-list").show()):"en"==a.lang&&(y._ijkey="#en-pick-",$("#en-pick-list").show()),c.dialog.injPickNo.trigger("click"),y._injpick)$(y._ijkey+y._injpick[o]).prop("checked",!0);N(c.dialog.injPick)}),c.dialog.injPickAll.on("click",function(e){$("#injpick-list input").prop("checked",!0)}),c.dialog.injPickNo.on("click",function(e){$("#injpick-list input").prop("checked",!1)}),c.dialog.injPickOK.on("click",function(e){var r=$(y._ijkey+"list"),o=[];y._injpick=r.find("input").each(function(e,r){var a=$(r),t=a.attr("id").slice(8);a.is(":checked")&&o.push(t)}),y._injpick=o,c.dialog.injPick.hide()}),c.dialog.kickVoteY.on("click",function(e){P("kickVote",{agree:!0}),clearTimeout(y._kickTimer),c.dialog.kickVote.hide()}),c.dialog.kickVoteN.on("click",function(e){P("kickVote",{agree:!1}),clearTimeout(y._kickTimer),c.dialog.kickVote.hide()}),c.dialog.purchaseOK.on("click",function(e){$.post("/buy/"+y._sgood,function(e){var r=y.users[y.id];if(e.error)return hr(e.error);alert(L.purchased),r.money=e.money,r.box=e.box,Z()}),c.dialog.purchase.hide()}),c.dialog.purchaseNO.on("click",function(e){c.dialog.purchase.hide()}),c.dialog.obtainOK.on("click",function(e){var r=y._obtain.shift();r?pr(r):c.dialog.obtain.hide()}),r=0;r<5;r++)$("#team-"+r).on("click",b);function b(e){$(".team-selector").hasClass("team-unable")||P("team",{value:$(e.currentTarget).attr("id").slice(5)})}function _(){(l=new T(y.URL)).onopen=function(e){E()},l.onmessage=_onMessage=function(e){U(JSON.parse(e.data))},l.onclose=function(e){var r=L.closed+" (#"+e.code+")";d&&d.close(),rr(),alert(r),$.get("/kkutu_notice.html",function(e){E(e)})},l.onerror=function(e){console.warn(L.error,e),C=!1}}$("#replay-file").on("change",function(e){var r=e.target.files[0],o=new FileReader,a=$("#replay-date").html("-"),t=$("#replay-version").html("-"),i=$("#replay-players").html("-");m=!1,c.dialog.replayView.attr("disabled",!0),r&&(o.readAsText(r),o.onload=function(e){var r,o;try{for(r in o=JSON.parse(e.target.result),a.html(new Date(o.time).toLocaleString()),t.html(o.version),i.empty(),o.players){var s,n=o.players[r];i.append(s=$("<div>").addClass("replay-player-bar ellipse").html(n.title).prepend(He(n.data.score).addClass("users-level"))),n.id==o.me&&s.css("font-weight","bold")}m=o,c.dialog.replayView.attr("disabled",!1)}catch(e){return console.warn(e),alert(L.replayError)}})}),c.dialog.replayView.on("click",function(e){!function(){var e;for(e in Se(),y._replay=!0,y.room={title:m.title,players:[],events:[],time:m.roundTime,round:m.round,mode:m.mode,limit:m.limit,game:m.game,opts:m.opts,readies:m.readies},ye(),m.events)y.room.events.push(m.events[e]);c.box.userList.hide(),c.box.roomList.hide(),c.box.game.show(),c.dialog.replay.hide(),_e(),le(!0),y.$gp=$(".GameBox .product-title").empty().append(y.$gpt=$("<div>").addClass("game-replay-title")).append(y.$gpc=$("<div>").addClass("game-replay-controller").append($("<button>").html(L.replayNext).on("click",Le)).append($("<button>").html(L.replayPause).on("click",Ce)).append($("<button>").html(L.replayPrev).on("click",we))),y._gpp=L.replay+" - "+new Date(m.time).toLocaleString(),y._gtt=y.room.events[y.room.events.length-1].time,y._eventTime=0,y._rt=G(Te,2e3),y._rprev=0,y._rpause=!1,xe()}()}),I(function(){B>0?B=0:O>0&&(O-=.03)},1e3),S(function(){!C||y.room||y._gaming||P("updateData")},18e3)}),w.Classic.roundReady=function(r){y.room.game.title.length;qe(),y._roundTime=1e3*y.room.time,c.game.display.html(Je(r.char,r.subChar)),c.game.chain.show().html(y.chain=0),y.room.opts.mission&&c.game.items.show().css("opacity",1).html(y.mission=r.mission),"KAP"==e[y.room.mode]&&$(".jjoDisplayBar .graph-bar").css({float:"right","text-align":"left"}),Re(r.round),er("round_start"),je("roundReady")},w.Classic.turnStart=function(e){y.room.game.turn=e.turn,e.seq&&(y.room.game.seq=e.seq),(y._tid=y.room.game.seq[e.turn])&&(y._tid.robot&&(y._tid=y._tid.id),e.id=y._tid,c.game.display.html(y._char=Je(e.char,e.subChar,e.wordLength)),$("#game-user-"+e.id).addClass("game-user-current"),y._replay||(c.game.here.css("display",e.id==y.id?"block":"none"),e.id==y.id&&(u?c.game.hereText.val("").focus():c.talk.focus())),c.game.items.html(y.mission=e.mission),l.onmessage=_onMessage,clearInterval(y._tTime),y._chars=[e.char,e.subChar],y._speed=e.speed,y._tTime=I(De,f),y.turnTime=e.turnTime,y._turnTime=e.turnTime,y._roundTime=e.roundTime,y._turnSound=er("T"+e.speed),je("turnStart"))},w.Classic.turnGoing=function(){y.room||clearInterval(y._tTime),y._turnTime-=f,y._roundTime-=f,c.game.turnBar.width(y._timePercent()).html((.001*y._turnTime).toFixed(1)+L.SECOND),c.game.roundBar.width(y._roundTime/y.room.time*.1+"%").html((.001*y._roundTime).toFixed(1)+L.SECOND),c.game.roundBar.hasClass("round-extreme")||y._roundTime<=5e3&&c.game.roundBar.addClass("round-extreme")},w.Classic.turnEnd=function(r,o){var a,t=$("<div>").addClass("deltaScore").html(o.score>0?"+"+(o.score-o.bonus):o.score),i=$(".game-user-current");y._turnSound&&y._turnSound.stop(),Oe(r,o.score),clearInterval(y._tTime),o.ok?(ke(),clearTimeout(y._fail),c.game.here.hide(),c.game.chain.html(++y.chain),Ge(o.value,o.mean,o.theme,o.wc)):(ke(r),t.addClass("lost"),$(".game-user-current").addClass("game-user-bomb"),c.game.here.hide(),er("timeout")),o.hint&&(o.hint=o.hint._id,-1==(a=o.hint.indexOf(y._chars[0]))&&(a=o.hint.indexOf(y._chars[1])),"KAP"==e[y.room.mode]?c.game.display.empty().append($("<label>").css("color","#AAAAAA").html(o.hint.slice(0,a))).append($("<label>").html(o.hint.slice(a))):c.game.display.empty().append($("<label>").html(o.hint.slice(0,a+1))).append($("<label>").css("color","#AAAAAA").html(o.hint.slice(a+1)))),o.bonus&&(u?t.html("+"+(b.score-b.bonus)+"+"+b.bonus):G(function(){var e=$("<div>").addClass("deltaScore bonus").html("+"+o.bonus);Be(i,e)},500)),Be(i,t).removeClass("game-user-current"),ce(r,Ae(r))},w.Jaqwi.roundReady=function(e){var r=L.jqTheme+": "+L["theme_"+e.theme];qe(),y._roundTime=1e3*y.room.time,y._fastTime=1e4,c.game.display.html(r),c.game.items.hide(),c.game.hints.show(),$(".jjo-turn-time .graph-bar").width("100%").html(r).css("text-align","center"),Re(e.round),er("round_start"),clearInterval(y._tTime)},w.Jaqwi.turnStart=function(e){$(".game-user-current").removeClass("game-user-current"),$(".game-user-bomb").removeClass("game-user-bomb"),y.room.game.seq.indexOf(y.id)>=0&&c.game.here.show(),c.game.display.html(y._char=e.char),clearInterval(y._tTime),y._tTime=I(De,f),Xe("jaqwi")},w.Jaqwi.turnGoing=function(){var e,r,o=c.game.roundBar;y.room||clearInterval(y._tTime),y._roundTime-=f,r=y._spectate?L.stat_spectate:(.001*y._roundTime).toFixed(1)+L.SECOND,o.width(y._roundTime/y.room.time*.1+"%").html(r),o.hasClass("round-extreme")||y._roundTime<=y._fastTime&&(e=y.bgm.currentTime/y.bgm.duration,y.bgm.paused?Ze():Xe("jaqwiF"),y.bgm.currentTime=y.bgm.duration*e,o.addClass("round-extreme"))},w.Jaqwi.turnHint=function(e){er("mission"),function(e){var r,o=Ue("",e);c.game.hints.append(r=$("<div>").addClass("hint-item").append($("<label>").html(o)).append($("<div>").addClass("expl").css({"white-space":"normal",width:200}).html(o.html()))),u||r.width(0).animate({width:215});global.expl(r)}(e.hint)},w.Jaqwi.turnEnd=function(e,r){var o=$("<div>").addClass("deltaScore").html("+"+r.score),a=$("#game-user-"+e);r.giveup?a.addClass("game-user-bomb"):r.answer?(c.game.here.hide(),c.game.display.html($("<label>").css("color","#FFFF44").html(r.answer)),Ze(),er("horr")):(e==y.id&&c.game.here.hide(),Oe(e,r.score),y._roundTime>1e4&&(y._roundTime=1e4),Be(a,o),ce(e,Ae(e)).addClass("game-user-current"),er("success"))},w.Crossword.roundReady=function(e,r){var o=e.seq?e.seq.indexOf(y.id):-1;qe(),$(".jjoriping,.rounds,.game-body").addClass("cw"),y._roundTime=1e3*y.room.time,y._fastTime=3e4,y.selectedRound=-1==o?1:o%y.room.round+1,c.game.items.hide(),c.game.cwcmd.show().css("opacity",0),Re(y.selectedRound),r||er("round_start"),clearInterval(y._tTime)},w.Crossword.turnEnd=function(e,r){var o,a,t=$("<div>").addClass("deltaScore").html("+"+r.score),i=$("#game-user-"+e);r.score?(a=r.pos.join(","),e==y.id?(c.game.cwcmd.css("opacity",0),er("success")):(y._sel&&r.pos.join(",")==y._sel.join(",")&&c.game.cwcmd.css("opacity",0),er("mission")),y._bdb[a][4]=r.value,y._bdb[a][5]=e,r.pos[0]==y.selectedRound-1?w.Crossword.drawDisplay():(o=$(c.game.round.children("label").get(r.pos[0])).addClass("round-effect"),G(function(){o.removeClass("round-effect")},800)),Oe(e,r.score),ce(e,Ae(e)),Be(i,t)):(Ze(),c.game.round.empty(),er("horr"))},w.Crossword.drawDisplay=function(){var e,r,o,a,t,i,s,n,l,d=y._boards[y.selectedRound-1],m=c.game.display.empty(),u={};for(r in d)for(a=Number(d[r][0]),t=Number(d[r][1]),i="1"==d[r][2],s=Number(d[r][3]),n=d[r][4],m.append(e=$("<div>").addClass("cw-bar").attr("id","cw-"+a+"-"+t+"-"+d[r][2]).css({top:12.5*t+"%",left:12.5*a+"%",width:12.5*(i?1:s)+"%",height:12.5*(i?s:1)+"%"})),n&&e.addClass("cw-open"),d[r][5]==y.id?e.addClass("cw-my-open"):e.on("click",w.Crossword.onBar).on("mouseleave",w.Crossword.onSwap),o=0;o<s;o++)l=a+"-"+t,n&&(u[l]=n.charAt(o)),e.append($("<div>").addClass("cw-cell").attr("id","cwc-"+l).html(u[l]||"")),i?t++:a++},w.Crossword.onSwap=function(e){c.game.display.prepend($(e.currentTarget))},w.Crossword.onRound=function(e){var r=$(e.currentTarget).html().charCodeAt(0)-9311;Re(y.selectedRound=r),$(".rounds label").on("click",w.Crossword.onRound),w.Crossword.drawDisplay()},w.Crossword.onBar=function(e){var r=$(e.currentTarget).attr("id").slice(3).split("-"),o=y._means[y.selectedRound-1][r.join(",")],a="1"==o.dir;c.game.cwcmd.css("opacity",1),y._sel=[y.selectedRound-1,r[0],r[1],r[2]],$(".cw-q-head").html(L[a?"cwVert":"cwHorz"]+o.len+L.cwL),$("#cw-q-input").val("").focus(),$(".cw-q-body").html(Ue("★",o.mean,o.theme,o.type.split(",")))},w.Crossword.turnStart=function(e,r){var o,a;for(o in y._bdb={},y._boards=e.boards,y._means=e.means,e.boards)for(a in e.boards[o])y._bdb[[o,e.boards[o][a][0],e.boards[o][a][1],e.boards[o][a][2]].join(",")]=e.boards[o][a];$(".rounds label").on("click",w.Crossword.onRound),w.Crossword.drawDisplay(),clearInterval(y._tTime),y._tTime=I(De,f),Xe("jaqwi")},w.Crossword.turnGoing=w.Jaqwi.turnGoing,w.Crossword.turnHint=function(e){er("fail")},w.Typing.roundReady=function(e){y.room.game.title.length;y._chatter=u?c.game.hereText:c.talk,qe(),y._round=e.round,y._roundTime=1e3*y.room.time,y._fastTime=1e4,y._list=e.list.concat(e.list),y.chain=0,R(),Re(e.round),er("round_start"),je("roundReady")},w.Typing.spaceOn=function(){y.room.opts.proverb||(y._spaced=!0,$("body").on("keydown","#"+y._chatter.attr("id"),q))},w.Typing.spaceOff=function(){delete y._spaced,$("body").off("keydown","#"+y._chatter.attr("id"),q)},w.Typing.turnStart=function(e){y._spectate||(c.game.here.show(),u?c.game.hereText.val("").focus():c.talk.val("").focus(),w.Typing.spaceOn()),l.onmessage=_onMessage,clearInterval(y._tTime),y._tTime=I(De,f),y._roundTime=e.roundTime,Xe("jaqwi"),je("turnStart")},w.Typing.turnGoing=w.Jaqwi.turnGoing,w.Typing.turnEnd=function(e,r){var o=$("<div>").addClass("deltaScore").html("+"+r.score),a=$("#game-user-"+e);r.error?(y.chain++,R(),er("fail")):r.ok?(y.id==e?(y.chain++,R(),er("mission"),Ke(r.value,"")):y._spectate&&er("mission"),Oe(e,r.score),Be(a,o),ce(e,Ae(e))):(clearInterval(y._tTime),w.Typing.spaceOff(),c.game.here.hide(),Ze(),er("horr"),G(A,1e3,r.speed),y._round<y.room.round&&D(10))},w.Hunmin.roundReady=function(e){y.room.game.title.length;qe(),y._roundTime=1e3*y.room.time,c.game.display.html(y._char="&lt;"+e.theme+"&gt;"),c.game.chain.show().html(y.chain=0),y.room.opts.mission&&c.game.items.show().css("opacity",1).html(y.mission=e.mission),Re(e.round),er("round_start"),je("roundReady")},w.Hunmin.turnStart=function(e){y.room.game.turn=e.turn,e.seq&&(y.room.game.seq=e.seq),y._tid=y.room.game.seq[e.turn],y._tid.robot&&(y._tid=y._tid.id),e.id=y._tid,c.game.display.html(y._char),$("#game-user-"+e.id).addClass("game-user-current"),y._replay||(c.game.here.css("display",e.id==y.id?"block":"none"),e.id==y.id&&(u?c.game.hereText.val("").focus():c.talk.focus())),c.game.items.html(y.mission=e.mission),l.onmessage=_onMessage,clearInterval(y._tTime),y._chars=[e.char,e.subChar],y._speed=e.speed,y._tTime=I(De,f),y.turnTime=e.turnTime,y._turnTime=e.turnTime,y._roundTime=e.roundTime,y._turnSound=er("T"+e.speed),je("turnStart")},w.Hunmin.turnGoing=w.Classic.turnGoing,w.Hunmin.turnEnd=function(e,r){var o,a=$("<div>").addClass("deltaScore").html(r.score>0?"+"+(r.score-r.bonus):r.score),t=$(".game-user-current");y._turnSound.stop(),Oe(e,r.score),clearInterval(y._tTime),r.ok?(clearTimeout(y._fail),c.game.here.hide(),c.game.chain.html(++y.chain),Ge(r.value,r.mean,r.theme,r.wc)):(a.addClass("lost"),$(".game-user-current").addClass("game-user-bomb"),c.game.here.hide(),er("timeout")),r.hint&&(r.hint=r.hint._id,-1==(o=r.hint.indexOf(y._chars[0]))&&(o=r.hint.indexOf(y._chars[1])),c.game.display.empty().append($("<label>").html(r.hint.slice(0,o+1))).append($("<label>").css("color","#AAAAAA").html(r.hint.slice(o+1)))),r.bonus&&(u?a.html("+"+(b.score-b.bonus)+"+"+b.bonus):G(function(){var e=$("<div>").addClass("deltaScore bonus").html("+"+r.bonus);Be(t,e)},500)),Be(t,a).removeClass("game-user-current"),ce(e,Ae(e))},w.Daneo.roundReady=function(e){y.room.game.title.length;qe(),y._roundTime=1e3*y.room.time,c.game.display.html(y._char="&lt;"+L["theme_"+e.theme]+"&gt;"),c.game.chain.show().html(y.chain=0),y.room.opts.mission&&c.game.items.show().css("opacity",1).html(y.mission=e.mission),Re(e.round),er("round_start"),je("roundReady")},w.Daneo.turnStart=function(e){y.room.game.turn=e.turn,e.seq&&(y.room.game.seq=e.seq),y._tid=y.room.game.seq[e.turn],y._tid.robot&&(y._tid=y._tid.id),e.id=y._tid,c.game.display.html(y._char),$("#game-user-"+e.id).addClass("game-user-current"),y._replay||(c.game.here.css("display",e.id==y.id?"block":"none"),e.id==y.id&&(u?c.game.hereText.val("").focus():c.talk.focus())),c.game.items.html(y.mission=e.mission),l.onmessage=_onMessage,clearInterval(y._tTime),y._chars=[e.char,e.subChar],y._speed=e.speed,y._tTime=I(De,f),y.turnTime=e.turnTime,y._turnTime=e.turnTime,y._roundTime=e.roundTime,y._turnSound=er("T"+e.speed),je("turnStart")},w.Daneo.turnGoing=w.Classic.turnGoing,w.Daneo.turnEnd=function(e,r){var o,a=$("<div>").addClass("deltaScore").html(r.score>0?"+"+(r.score-r.bonus):r.score),t=$(".game-user-current");y._turnSound.stop(),Oe(e,r.score),clearInterval(y._tTime),r.ok?(clearTimeout(y._fail),c.game.here.hide(),c.game.chain.html(++y.chain),Ge(r.value,r.mean,r.theme,r.wc)):(a.addClass("lost"),$(".game-user-current").addClass("game-user-bomb"),c.game.here.hide(),er("timeout")),r.hint&&(r.hint=r.hint._id,-1==(o=r.hint.indexOf(y._chars[0]))&&(o=r.hint.indexOf(y._chars[1])),c.game.display.empty().append($("<label>").html(r.hint.slice(0,o+1))).append($("<label>").css("color","#AAAAAA").html(r.hint.slice(o+1)))),r.bonus&&(u?a.html("+"+(b.score-b.bonus)+"+"+b.bonus):G(function(){var e=$("<div>").addClass("deltaScore bonus").html("+"+r.bonus);Be(t,e)},500)),Be(t,a).removeClass("game-user-current"),ce(e,Ae(e))},w.Sock.roundReady=function(r,o){r.seq&&r.seq.indexOf(y.id);qe(),y._relay=!0,$(".jjoriping,.rounds,.game-body").addClass("cw"),y._va=[],y._lang=s[e[y.room.mode]].lang,y._board=r.board,y._maps=[],y._roundTime=1e3*y.room.time,y._fastTime=1e4,c.game.items.hide(),c.game.bb.show(),w.Sock.drawDisplay(),Re(r.round),o||er("round_start"),clearInterval(y._tTime)},w.Sock.turnEnd=function(e,r){var o,a,t,i=$("<div>").addClass("deltaScore").html("+"+r.score),s=$("#game-user-"+e);if(r.score){for(t=(o=r.value).length,y._maps.push(o),a=0;a<t;a++)y._board=y._board.replace(o.charAt(a),"　");e==y.id?er("success"):er("mission"),w.Sock.drawDisplay(),Oe(e,r.score),ce(e,Ae(e)),Be(s,i)}else Ze(),y._relay=!1,er("horr")},w.Sock.drawMaps=function(){c.game.bb.empty(),y._maps.sort(function(e,r){return r.length-e.length}).forEach(function(e){c.game.bb.append(function(e){var r,o=$("<div>").addClass("bb-word"),a=e.length;for(r=0;r<a;r++)o.append($("<div>").addClass("bb-char").html(e.charAt(r)));return o}(e))})},w.Sock.drawDisplay=function(){var e,r=$("<div>").css("height","100%"),o=y._board.split(""),a="ko"==y._lang?"12.5%":"10%";o.forEach(function(o,t){r.append(e=$("<div>").addClass("sock-char sock-"+o).css({width:a,height:a}).html(o)),y._va[t]&&y._va[t]!=o&&e.html(y._va[t]).addClass("sock-picked").animate({opacity:0},500)}),y._va=o,c.game.display.empty().append(r),w.Sock.drawMaps()},w.Sock.turnStart=function(e,r){clearInterval(y._tTime),y._tTime=I(De,f),Xe("jaqwi")},w.Sock.turnGoing=w.Jaqwi.turnGoing,w.Sock.turnHint=function(e){er("fail")};var O=0,B=0;function M(e,r){var o=e.toString();return"000000000000000".slice(0,Math.max(0,r-o.length))+o}function P(e,r,o){var a,t={type:e},i=o?l:d||l;for(a in r)t[a]=r[a];if("test"!=e&&B++>10){if(++O>=3)return i.close();B=5}i.send(JSON.stringify(t))}function E(e){e?$("#Intro").is(":visible")?(c.loading.hide(),$("#intro-text").html(e)):c.loading.show().html(e):c.loading.hide()}function N(e,r){var o=[$(window).width(),$(window).height()];return!r&&e.is(":visible")?(e.hide(),!1):($(".dialog-front").removeClass("dialog-front"),e.show().addClass("dialog-front").css({left:.5*(o[0]-e.width()),top:.5*(o[1]-e.height())}),!0)}function F(e){y.opts=e,y.muteBGM=y.opts.mb,y.muteEff=y.opts.me,$("#mute-bgm").attr("checked",y.muteBGM),$("#mute-effect").attr("checked",y.muteEff),$("#deny-invite").attr("checked",y.opts.di),$("#deny-whisper").attr("checked",y.opts.dw),$("#deny-friend").attr("checked",y.opts.df),$("#auto-ready").attr("checked",y.opts.ar),$("#sort-user").attr("checked",y.opts.su),$("#only-waiting").attr("checked",y.opts.ow),$("#only-unlock").attr("checked",y.opts.ou),y.bgm&&(y.muteBGM?(y.bgm.volume=0,y.bgm.stop()):(y.bgm.volume=1,y.bgm=Xe(y.bgm.key,!0)))}function I(e,r,o,a,t,i,s){var n=S(e,r,o,a,t,i,s);return y._timers.push(n),n}function G(e,r,o,a,t,i,s){var n=j(e,r,o,a,t,i,s);return y._timers.push(n),n}function K(r,o,a,t,i,n){if(y.room){var l=s[e[y.room.mode]];if(!l)return null;w[l.rule][r].call(this,o,a,t,i,n)}}function U(e){var r,o,a,t,i,s,n,u,p;switch(e.type){case"recaptcha":var f=$("#intro-text");f.empty(),f.html("게스트는 캡챠 인증이 필요합니다.<br/>로그인을 하시면 캡챠 인증을 건너뛰실 수 있습니다.<br/><br/>"),f.append($('<div class="g-recaptcha" id="recaptcha" style="display: table; margin: 0 auto;"></div>')),grecaptcha.render("recaptcha",{sitekey:e.siteKey,callback:function(e){l.send(JSON.stringify({type:"recaptcha",token:e}))}});break;case"welcome":y.id=e.id,y.guest=e.guest,y.admin=e.admin,y.users=e.users,y.robots={},y.rooms=e.rooms,y.place=0,y.friends=e.friends,y._friends={},y._playTime=e.playTime,y._okg=e.okg,y._gaming=!1,y.nickname=e.nickname,y.exordial=e.exordial,y.box=e.box,e.test&&alert(L.welcomeTestServer),location.hash[1]&&or(location.hash.slice(1)),z(void 0,!0),function(){Xe("lobby"),$("#Intro").animate({opacity:1},1e3).animate({opacity:0},1e3),$("#intro-text").text(L.welcome),G(function(){$("#Intro").hide()},2e3),y.admin&&console.log("관리자 모드");C=!0}(),e.caj&&function(){if(!confirm(L.checkAgeAsk))return P("caj",{answer:"no"},!0);for(;;){for(var e=[],r=1;r<=3;){var o=prompt(L["checkAgeInput"+r]);if(o&&!isNaN(o=Number(o)))1==r&&(o<1e3||o>2999)?alert(o+"\n"+L.checkAgeNo):2==r&&(o<1||o>12)?alert(o+"\n"+L.checkAgeNo):3==r&&(o<1||o>31)?alert(o+"\n"+L.checkAgeNo):e[r++-1]=o;else if(--r<1)break}if(4==r){if(confirm(L.checkAgeSure+"\n"+e[0]+L.YEAR+" "+e[1]+L.MONTH+" "+e[2]+L.DATE))return P("caj",{answer:"yes",input:[e[1],e[2],e[0]]},!0)}else if(confirm(L.checkAgeCancel))return P("caj",{answer:"no"},!0)}}(),ve();break;case"conn":y.setUser(e.user.id,e.user),re();break;case"disconn":y.setUser(e.id,null),re();break;case"connRoom":y._preQuick&&(er("success"),c.dialog.quick.hide(),delete y._preQuick),c.dialog.quick.hide(),y.setUser(e.user.id,e.user),(o=y.usersR[e.user.id]=e.user).id==y.id?E():sr((o.profile.title||o.profile.name)+L.hasJoined),re();break;case"disconnRoom":(o=y.usersR[e.id])&&(delete y.usersR[e.id],sr((o.profile.title||o.profile.name)+L.hasLeft),re());break;case"yell":vr(e.value),sr(e.value,L.yell);break;case"dying":vr(L.dying),sr(L.dying,L.yell);break;case"tail":sr(e.a+"|"+e.rid+"@"+e.id+": "+(e.msg instanceof String?e.msg:JSON.stringify(e.msg)).replace(/</g,"&lt;").replace(/>/g,"&gt;"),"tail");break;case"chat":e.notice?sr(L["error_"+e.code]):ir(e.profile||{title:L.robot},e.value,e.from,e.timestamp);break;case"roomStuck":d.close();break;case"preRoom":n=e.channel,u=e.id,p=y.URL.replace(/:(\d+)/,function(e,r){return":"+(Number(r)+416+Number(n)-1)})+"&"+n+"&"+u,d||(d=new T(p),E(L.connectToRoom+"\n<center><button id='ctr-close'>"+L.ctrCancel+"</button></center>"),$("#ctr-close").on("click",function(){E(),d&&d.close()}),d.onopen=function(e){console.log("room-conn",n,u)},d.onmessage=_onMessage,d.onclose=function(e){console.log("room-disc",n,u),d=void 0},d.onerror=function(e){console.warn(L.error,e)});break;case"room":Y(e),function(e){if(!y._players)return;if(!y.room)return;var r,o,a={}+"",t=y._players.split(",");t.length,y.room.players.length;for(r in t)t[r]==a&&0;for(r in y.room.players)y.room.players[r].robot&&0;if(e){for(r in t)t[r]!=a&&(y.users[t[r]].game.ready=!1);sr(L.hasModified)}y._gaming!=y.room.gaming&&(y.room.gaming?(_e(),y._replay=!1,function(e){var r,o;for(r in m={version:y.version,me:y.id,players:[],events:[],title:y.room.title,roundTime:y.room.time,round:y.room.round,mode:y.room.mode,limit:y.room.limit,game:y.room.game,opts:y.room.opts,readies:y.room.readies,time:(new Date).getTime()},y.room.players){var a;o=y.users[y.room.players[r]]||y.room.players[r],a={id:o.id,score:0},o.robot?(a.id=o.id,a.robot=!0,a.data={score:0},o={profile:ne(o.level)}):(a.data=o.data,a.equip=o.equip),a.title="#"+o.id,m.players.push(a)}y._record=!0}(y.room.game.title)):(y._spectate?(c.dialog.resultSave.hide(),y._spectate=!1,Xe("lobby")):(c.dialog.resultSave.show(),y.resulting=!0),clearInterval(y._tTime)));y._master!=y.room.master&&sr(((o=y.users[y.room.master]).profile.title||o.profile.name)+L.hasMaster);y._players=y.room.players.toString(),y._master=y.room.master,y._gaming=y.room.gaming}(e.modify&&e.myRoom),z(e.myRoom),e.modify&&y.room&&e.myRoom&&(y._rTitle!=y.room.title&&X(".room-head-title"),y._rMode!=Qe(y.room.mode,y.room.opts,!0)&&X(".room-head-mode"),y._rLimit!=y.room.limit&&X(".room-head-limit"),y._rRound!=y.room.round&&X(".room-head-round"),y._rTime!=y.room.time&&X(".room-head-time"));break;case"user":y.setUser(e.id,e),y.room&&z(y.room.id==e.place);break;case"updateProfile":y.users[e.id].nickname=e.nickname,y.users[e.id].exordial=e.exordial;break;case"updateData":y.id=e.id,y.guest=e.guest,y.admin=e.admin,y.users=e.users,y.rooms=e.rooms,y.friends=e.friends,y._playTime=e.playTime,y._okg=e.okg,y.nickname=e.nickname,y.exordial=e.exordial,y.box=e.box,z(void 0,!0),ve();break;case"friends":for(r in y._friends={},e.list)e.list[r].forEach(function(e){y._friends[e]={server:r}});ve();break;case"friend":y._friends[e.id]={server:"on"==e.stat&&e.s},y._friends[e.id]&&y.friends[e.id]&&sr(("on"==e.stat?"&lt;<b>"+L["server_"+y._friends[e.id].server]+"</b>&gt; ":"")+L.friend+" "+y.friends[e.id]+L["fstat_"+e.stat]),ve();break;case"friendAdd":o=y.users[e.from].profile,r=(o.title||o.name)+"(#"+e.from.substr(0,5)+")",P("friendAddRes",{from:e.from,res:!y.opts.df&&confirm(r+L.attemptFriendAdd)},!0);break;case"friendAddRes":o=y.users[e.target].profile,sr((r=(o.title||o.name)+"(#"+e.target.substr(0,5)+")")+L["friendAddRes_"+(e.res?"ok":"no")]),e.res&&(y.friends[e.target]=o.title||o.name,y._friends[e.target]={server:y.server},ve());break;case"friendEdit":y.friends=e.friends,ve();break;case"starting":E(L.gameLoading);break;case"roundReady":K("roundReady",e);break;case"turnStart":K("turnStart",e);break;case"turnError":i=e.code,s=e.value,c.game.display.empty().append($("<label>").addClass("game-fail-text").text((L["turnError_"+i]?L["turnError_"+i]+": ":"")+s)),er("fail"),clearTimeout(y._fail),y._fail=G(function(){c.game.display.html(y._char)},1800);break;case"turnHint":K("turnHint",e);break;case"turnEnd":e.score=Number(e.score),e.bonus=Number(e.bonus),y.room&&(y._tid=e.target||y.room.game.seq[y.room.game.turn],y._tid&&(y._tid.robot&&(y._tid=y._tid.id),function(e,r){K("turnEnd",e,r)}(y._tid,e)),e.baby&&er("success"));break;case"roundEnd":for(r in e.users)y.setUser(r,e.users[r]);y._resultRank=e.ranks,function(e,r){r||(r={});var o,a,t,i,s,n,l,d,u,p=$(".result-board").empty();for(o in $(".result-me-expl").empty(),c.game.display.html(L.roundEnd),y._resultPage=1,y._result=null,e)t=e[o],(a=y._replay?m.users[t.id]:y.users[t.id])||(a=g),a.data&&t.reward&&(t.reward.score=y._replay?0:Math.round(t.reward.score),n=We(l=a.data.score)>We(a.data.score-t.reward.score),p.append(i=$("<div>").addClass("result-board-item").append(s=$("<div>").addClass("result-board-rank").html(t.rank+1)).append(He(l).addClass("result-board-level")).append($("<div>").addClass("result-board-name").html(a.profile.title||a.profile.name)).append($("<div>").addClass("result-board-score").html(r.scores?L.avg+" "+fr(r.scores[t.id])+L.kpm:fr(t.score||0)+L.PTS)).append($("<div>").addClass("result-board-reward").html(t.reward.score?"+"+fr(t.reward.score):"-")).append($("<div>").addClass("result-board-lvup").css("display",n?"block":"none").append($("<i>").addClass("fa fa-arrow-up")).append($("<div>").html(L.lvUp)))),a.game.team&&s.addClass("team-"+a.game.team),t.id==y.id&&(t.exp=a.data.score-t.reward.score,t.level=We(t.exp),y._result=t,i.addClass("result-board-me"),$(".result-me-expl").append(b(t.reward._score,t.reward._money,t.reward._blog))));$(".result-me").css("opacity",0),y._coef=0,y._result&&(d=y._result.reward.score-y._result.reward._score,u=y._result.reward.money-y._result.reward._money,y._result._exp=y._result.exp,y._result._score=y._result.reward.score,y._result._bonus=d,y._result._boing=y._result.reward._score,y._result._addit=d,y._result._addp=u,d=d>0?"<label class='result-me-bonus'>(+"+fr(d)+")</label>":"",u=u>0?"<label class='result-me-bonus'>(+"+fr(u)+")</label>":"",sr(L.scoreGain+": "+fr(y._result.reward.score)+", "+L.moneyGain+": "+fr(y._result.reward.money)),$(".result-me").css("opacity",1),$(".result-me-score").html(L.scoreGain+" +"+fr(y._result.reward.score)+d),$(".result-me-money").html(L.moneyGain+" +"+fr(y._result.reward.money)+u));function f(e){var r,o,a;y._result.goal=h[y._result.level-1],y._result.before=h[y._result.level-2]||0,y._result.reward.score>0&&((r=y._result.reward.score*y._coef)<.05&&y._coef&&(r=y._result.reward.score),y._result.reward.score-=r,y._result.exp+=r,o=We(y._result.exp),y._result.level!=o&&(y._result._boing-=y._result.goal-y._result._exp,y._result._exp=y._result.goal,er("lvup")),y._result.level=o,G(f,50)),a=y._result.exp-y._result._exp,v("before",y._result._exp,y._result.before,y._result.goal),v("current",Math.min(a,y._result._boing),0,y._result.goal-y._result.before),v("bonus",Math.max(0,a-y._result._boing),0,y._result.goal-y._result.before),$(".result-me-level-body").html(y._result.level),$(".result-me-score-text").html(fr(Math.round(y._result.exp))+" / "+fr(y._result.goal))}function v(e,r,o,a){$(".result-me-"+e+"-bar").width((r-o)/(a-o)*100+"%")}function b(e,r,o){var a,t,i=$("<div>").append($("<h4>").html(L.scoreGain)).append(a=$("<div>")).append($("<h4>").html(L.moneyGain)).append(t=$("<div>"));function s(e,r,o){e.append($("<h5>").addClass("result-me-blog-head").html(r)).append($("<h5>").addClass("result-me-blog-body").html(o))}return s(a,L.scoreOrigin,e),s(t,L.moneyOrigin,r),o.forEach(function(o){var i,n,l,d=o.charAt(0),c=o.charAt(1),m=o.slice(2,5),u=Number(o.slice(5));"EXP"==m?(i=a,l=e):"MNY"==m&&(i=t,l=r),"g"==c?n="+"+(l*u).toFixed(1):"h"==c&&(n="+"+Math.floor(u)),s(i,L["bonusFrom_"+d],n)}),i}G(function(){N(c.dialog.result),y._result&&f(!0),c.dialog.result.css("opacity",0).animate({opacity:1},500),G(function(){y._coef=.05},500)},2e3),y._record=!1}(e.result,e.data);break;case"kickVote":y._kickTarget=y.users[e.target],y.id!=e.target&&y.id!=y.room.master&&(a=e.target,t=y.users[a].profile,$("#kick-vote-text").html((t.title||t.name)+L.kickVoteText),y.kickTime=10,y._kickTime=10,y._kickTimer=G(Pe,1e3),N(c.dialog.kickVote)),sr((y._kickTarget.profile.title||y._kickTarget.profile.name)+L.kickVoting);break;case"kickDeny":sr(J(y._kickTarget.profile,e));break;case"invited":P("inviteRes",{from:e.from,res:!y.opts.di&&confirm(e.from+L.invited)});break;case"inviteNo":sr(((o=y.users[e.target]).profile.title||o.profile.name)+L.inviteDenied);break;case"okg":y._playTime>e.time?sr(L.okgExpired):y._okg!=e.count&&sr(L.okgNotice+" ("+L.okgCurrent+e.count+")"),y._playTime=e.time,y._okg=e.count;break;case"obtain":ur(e);break;case"expired":for(r in e.list)sr(dr(e.list[r])+L.hasExpired);break;case"blocked":sr(L.blocked);break;case"test":(y._test=!y._test)?(y._testt=I(function(){c.talk.val()!=y._ttv&&(P("test",{ev:"c",v:c.talk.val()},!0),y._ttv=c.talk.val())},100),document.onkeydown=function(e){P("test",{ev:"d",c:e.keyCode},!0)},document.onkeyup=function(e){P("test",{ev:"u",c:e.keyCode},!0)}):(clearInterval(y._testt),document.onkeydown=void 0,document.onkeyup=void 0);break;case"error":if(r=e.message||"",401==e.code);else if(403==e.code)E();else if(406==e.code){if(c.dialog.quick.is(":visible")){y._preQuick=!1;break}}else if(409==e.code)r=L["server_"+r];else{if(416==e.code)return void(confirm(L["error_"+e.code])&&(Ze(),y._spectate=!0,y._gaming=!0,P("enter",{id:e.target,password:y._pw,spectate:!0},!0)));if(413==e.code)c.dialog.room.hide(),c.menu.setRoom.trigger("click");else if(429==e.code)Xe("lobby");else if(430==e.code){if(y.setRoom(e.message,null),c.dialog.quick.is(":visible")){y._preQuick=!1;break}}else if(431==e.code||432==e.code||433==e.code)c.dialog.room.show();else{if(444==e.code){if(-1!=(r=e.message).indexOf("생년월일")){alert("생년월일이 올바르게 입력되지 않아 게임 이용이 제한되었습니다. 잠시 후 다시 시도해 주세요.");break}if(!e.blockedUntil)break;var v="\n제한 시점: "+(b=new Date(parseInt(e.blockedUntil))).getFullYear()+"년 "+b.getMonth()+"1월 "+b.getDate()+"일 "+b.getHours()+"시 "+b.getMinutes()+"분까지";alert("[#444] "+L.error_444+r+v);break}if(446==e.code){if(r=e.reasonBlocked,!e.ipBlockedUntil)break;var b;v="\n제한 시점: "+(b=new Date(parseInt(e.ipBlockedUntil))).getFullYear()+"년 "+b.getMonth()+"1월 "+b.getDate()+"일 "+b.getHours()+"시 "+b.getMinutes()+"분까지";alert("[#446] "+L.error_446+r+v);break}if(447===e.code){alert("자동화 봇 방지를 위한 캡챠 인증에 실패했습니다. 메인 화면에서 다시 시도해 주세요.");break}}}alert("[#"+e.code+"] "+L["error_"+e.code]+r)}y._record&&je(e)}function J(e,r){var o=L.agree+" "+r.Y+", "+L.disagree+" "+r.N+L.kickCon;return r.Y>=r.N?o+=(e.title||e.name)+L.kicked:o+=(e.title||e.name)+L.kickDenied,o}function V(e,r){r.length&&(y._whisper=e,P("talk",{whisper:e,value:r},!0),ir({title:"→"+e},r,!0))}function W(e){y._shut.hasOwnProperty(e)?(delete y._shut[e],sr(e+L.userNShut)):(y._shut[e]=!0,sr(e+L.userShut))}function H(e,r){var o=(e=e.replace(/[^\sa-zA-Zㄱ-ㅎ0-9가-힣]/g,"")).match(/[ㄱ-ㅎ가-힣]/)?"ko":"en";if(e.length<1)return r({error:404});$.get("/dict/"+e+"?lang="+o,r)}function Y(e){var r,o,a,t;if(e.myRoom=y.place==e.room.id||e.target==y.id,e.myRoom){if($target=y.users[e.target],e.kickVote&&(sr(J($target.profile,e.kickVote)),$target.id==e.id&&alert(L.hasKicked)),-1==e.room.players.indexOf(y.id))y.room&&y.room.gaming&&(rr(),y.practicing=!1,y._gaming=!1,c.box.room.height(360),Xe("lobby")),y.users[y.id].game.ready=!1,y.users[y.id].game.team=0,y.users[y.id].game.form="J",c.menu.spectate.removeClass("toggled"),c.menu.ready.removeClass("toggled"),y.room=null,y.resulting=!1,y._players=null,y._master=null,y.place=0,e.room.practice&&(delete y.users[0],y.room=y._room,y.place=y._place,y.master=y.__master,y._players=y.__players,delete y._room);else if(e.room.practice&&!y.practicing&&(y.practicing=!0,y._room=y.room,y._place=y.place,y.__master=y.master,y.__players=y._players),y.room&&(y._players=y.room.players.toString(),y._master=y.room.master,y._rTitle=y.room.title,y._rMode=Qe(y.room.mode,y.room.opts,!0),y._rLimit=y.room.limit,y._rRound=y.room.round,y._rTime=y.room.time),y.room=e.room,y.place=y.room.id,y.master=y.room.master==y.id,e.spec&&e.target==y.id){if(y._spectate||(y._spectate=!0,qe(),Re()),e.boards){for(r in y.selectedRound=1,e.prisoners)for(o in a=r.split(","),e.boards[a[0]])if((t=e.boards[a[0]][o])[0]==a[1]&&t[1]==a[2]&&t[2]==a[3]){t[4]=e.prisoners[r];break}w.Crossword.roundReady(e,!0),w.Crossword.turnStart(e,!0)}for(r in e.spec)y.users[r].game.score=e.spec[r]}e.modify||e.target!=y.id||ar()}if(e.target&&y.users[e.target]&&(-1==e.room.players.indexOf(e.target)?y.users[e.target].place=0:y.users[e.target].place=e.room.id),!e.room.practice)if(e.room.players.length)for(r in y.setRoom(e.room.id,e.room),e.room.readies)y.users[r]&&(y.users[r].game.ready=e.room.readies[r].r,y.users[r].game.team=e.room.readies[r].t);else y.setRoom(e.room.id,null)}function Q(){return y.place?y.room.gaming||y.resulting?"for-gaming":y.master?"for-master":"for-normal":"for-lobby"}function z(e,r){var o,a=Q();if(y._replay){if(void 0!==e&&!e)return;Se()}if(!y._replay&&("for-gaming"!=a||e)){for(o in y.practicing&&(a="for-gaming"),$(".kkutu-menu button").hide(),c.box)c.box[o].hide();var t;c.box.me.show(),c.box.chat.show().width(790).height(190),c.chat.height(120),"for-lobby"==a?(y._ar_first=!0,c.box.userList.show(),y._shop?(c.box.roomList.hide(),c.box.shop.show()):(c.box.roomList.show(),c.box.shop.hide()),re(r||a!=y._only),function(e){var r,o=0;if(e)for(r in c.lobby.roomList.empty(),y.rooms)c.lobby.roomList.append(te(y.rooms[r])),o++;else for(r in $(".rooms-create").remove(),y.rooms)o++;c.lobby.roomListTitle.html(L.RoomList.replace("FA{bars}","<i class='fa fa-bars'></i>")+" ["+o+L.GAE+"]"),o?($(".rooms-gaming").css("display",y.opts.ow?"none":""),$(".rooms-locked").css("display",y.opts.ou?"none":"")):c.lobby.roomList.append(c.lobby.createBanner.clone().on("click",function(e){c.menu.newRoom.trigger("click")}))}(r||a!=y._only),Z(),y._jamsu&&(clearTimeout(y._jamsu),delete y._jamsu)):"for-master"==a||"for-normal"==a?($(".team-chosen").removeClass("team-chosen"),y.users[y.id].game.ready||"S"==y.users[y.id].game.form?(c.menu.ready.addClass("toggled"),$(".team-selector").addClass("team-unable")):(c.menu.ready.removeClass("toggled"),$(".team-selector").removeClass("team-unable"),$("#team-"+y.users[y.id].game.team).addClass("team-chosen"),y.opts.ar&&y._ar_first&&(c.menu.ready.addClass("toggled"),c.menu.ready.trigger("click"),y._ar_first=!1)),y._shop=!1,c.box.room.show().height(360),"for-master"==a&&c.dialog.inviteList.is(":visible")&&re(),le(!1),Z()):"for-gaming"==a&&(y._gAnim&&(c.box.room.show(),y._gAnim=!1),y._shop=!1,y._ar_first=!0,c.box.me.hide(),c.box.game.show(),$(".ChatBox").width(1e3).height(140),c.chat.height(70),le(!0)),y._only=a,t=y.place,location.hash=t?"#"+t:"",$(".kkutu-menu ."+a).show()}}function X(e){$(e).addClass("room-head-modified"),G(function(){$(e).removeClass("room-head-modified")},3e3)}function Z(){var e,r=y.users[y.id],o=0,a=We(r.data.score),t=h[a-2]||0,i=h[a-1];for(e in r.data.record)o+=r.data.record[e][1];gr(".my-image",r.equip),$(".my-stat-level").replaceWith(He(r.data.score).addClass("my-stat-level")),$(".my-stat-name").html(r.profile.title||r.profile.name),$(".my-stat-record").html(L.globalWin+" "+o+L.W),$(".my-stat-ping").html(fr(r.money)+L.ping),$(".my-okg .graph-bar").width(y._playTime%6e5/6e3+"%"),$(".my-okg-text").html(ee(y._playTime)),$(".my-level").html(L.LEVEL+" "+a),$(".my-gauge .graph-bar").width((r.data.score-t)/(i-t)*190),$(".my-gauge-text").html(fr(r.data.score)+" / "+fr(i))}function ee(e){var r=Math.floor(e/6e4)%60,o=Math.floor(.001*e)%60,a=Math.floor(e/36e5),t=[];return a&&t.push(a+L.HOURS),r&&t.push(r+L.MINUTE),a||t.push(o+L.SECOND),t.join(" ")}function re(e){var r,o,a,t=0;if(y.opts.su){for(r in a=[],y.users)t++,a.push(y.users[r]);a.sort(function(e,r){return r.data.score-e.data.score}),e=!0}else for(r in a=y.users,y.users)t++;if(c.lobby.userListTitle.html("<i class='fa fa-users'></i>&lt;<b>"+L["server_"+y.server]+"</b>&gt; "+L.UserList.replace("FA{users}","")+" ["+t+L.MN+"]"),e)for(r in c.lobby.userList.empty(),c.dialog.inviteList.empty(),a)(o=a[r]).robot||(c.lobby.userList.append(oe(o)),0==o.place&&c.dialog.inviteList.append(oe(o,!0)))}function oe(e,r){var o;return ae(o=r?$("<div>").attr("id","invite-item-"+e.id).addClass("invite-item users-item").append($("<div>").addClass("jt-image users-image").css("background-image","url('"+e.profile.image+"')")).append(He(e.data.score).addClass("users-level")).append($("<div>").addClass("users-name").html(e.profile.title||e.profile.name)).on("click",function(e){$e($(e.currentTarget).attr("id").slice(12))}):$("<div>").attr("id","users-item-"+e.id).addClass("users-item").append($("<div>").addClass("jt-image users-image").css("background-image","url('"+e.profile.image+"')")).append(He(e.data.score).addClass("users-level")).append($("<div>").addClass("users-name ellipse").html(e.profile.title||e.profile.name)).on("click",function(e){be($(e.currentTarget).attr("id").slice(11))}),e),o}function ae(e,r){r.equip.NIK&&e.addClass("x-"+r.equip.NIK),"b1_gm"==r.equip.BDG&&e.addClass("x-gm")}function te(r){var o,a,t=Qe(r.mode,r.opts);return o=$("<div>").attr("id","room-"+r.id).addClass("rooms-item").append(a=$("<div>").addClass("rooms-channel channel-"+r.channel).on("click",function(o){!function(r){var o=y.rooms[r],a=$("#ri-players").empty();y._roominfo=r,$("#RoomInfoDiag .dialog-title").html(r+L.sRoomInfo),$("#ri-title").html((o.password?"<i class='fa fa-lock'></i>&nbsp;":"")+o.title),$("#ri-mode").html(L["mode"+e[o.mode]]),$("#ri-round").html(o.round+", "+o.time+L.SECOND),$("#ri-limit").html(o.players.length+" / "+o.limit),o.players.forEach(function(e,r){var t,i,s=o.readies[e]||{};e=y.users[e]||g,o.players[r].robot?(e.profile={title:L.robot},e.equip={robot:!0}):s.t=s.t||0,a.append($("<div>").addClass("ri-player").append(i=$("<div>").addClass("moremi rip-moremi")).append(t=$("<div>").addClass("ellipse rip-title").html(e.profile.title||e.profile.name)).append($("<div>").addClass("rip-team team-"+s.t).html($("#team-"+s.t).html())).append($("<div>").addClass("rip-form").html(L["pform_"+s.f]))),e.id==o.master&&t.prepend($("<label>").addClass("rip-master").html("["+L.master+"]&nbsp;")),t.prepend(He(e.data.score).addClass("profile-level rip-level")),gr(i,e.equip)}),N(c.dialog.roomInfo),c.dialog.roomInfo.show()}(r.id)})).append($("<div>").addClass("rooms-number").html(r.id)).append($("<div>").addClass("rooms-title ellipse").text(tr(r.title))).append($("<div>").addClass("rooms-limit").html(r.players.length+" / "+r.limit)).append($("<div>").width(270).append($("<div>").addClass("rooms-mode").html(t.join(" / ").toString())).append($("<div>").addClass("rooms-round").html(L.rounds+" "+r.round)).append($("<div>").addClass("rooms-time").html(r.time+L.SECOND))).append($("<div>").addClass("rooms-lock").html(r.password?"<i class='fa fa-lock'></i>":"<i class='fa fa-unlock'></i>")).on("click",function(e){e.target!=a.get(0)&&or($(e.currentTarget).attr("id").slice(5))}),r.gaming&&o.addClass("rooms-gaming"),r.password&&o.addClass("rooms-locked"),o}function ie(e){var r,o,a,t=$("<div>").attr("id","game-user-"+e.id).addClass("game-user").append(r=$("<div>").addClass("moremi game-user-image")).append($("<div>").addClass("game-user-title").append(He(e.data.score).addClass("game-user-level")).append(a=$("<div>").addClass("game-user-name ellipse").html(e.profile.title||e.profile.name)).append($("<div>").addClass("expl").html(L.LEVEL+" "+We(e.data.score)))).append(o=$("<div>").addClass("game-user-score"));return gr(r,e.equip),global.expl(t),ae(a,e),e.game.team&&o.addClass("team-"+e.game.team),t}function se(e){var r,o,a=$("<div>").attr("id","game-user-"+e.id).addClass("game-user").append($("<div>").addClass("game-user-title").append(He(e.data.score).addClass("game-user-level")).append(o=$("<div>").addClass("game-user-name ellipse").html(e.profile.title||e.profile.name))).append(r=$("<div>").addClass("game-user-score"));return e.id==y.id&&o.addClass("game-user-my-name"),ae(o,e),e.game.team&&r.addClass("team-"+e.game.team),a}function ne(e){return{title:L["aiLevel"+e]+" "+L.robot,image:"/img/kkutu/robot.png"}}function le(r){var o,a,t,i,n,l,d,p=s[e[y.room.mode]],g=u||p.big?se:ie,f=!1,h=!0;if(ze($(".RoomBox .product-title"),y.room),ze($(".GameBox .product-title"),y.room),r){for(o in t=$(".GameBox .game-body").empty(),y.room.game.seq)(a=y._replay?m.users[y.room.game.seq[o]]||y.room.game.seq[o]:y.users[y.room.game.seq[o]]||y.robots[y.room.game.seq[o].id]||y.room.game.seq[o]).robot&&!a.profile&&(a.profile=ne(a.level),y.robots[a.id]=a),t.append(g(a)),ce(a.id,a.game.score||0);clearTimeout(y._jamsu),delete y._jamsu}else{for(o in t=$(".room-users").empty(),b="S"==y.users[y.id].game.form,y.room.players)if((a=y.users[y.room.players[o]]||y.room.players[o]).game){var v=a.game.practice?"/"+L.stat_practice:"",b="S"==a.game.form&&"/"+L.stat_spectate;a.robot&&(a.profile=ne(a.level),y.robots[a.id]=a),t.append($("<div>").attr("id","room-user-"+a.id).addClass("room-user").append(l=$("<div>").addClass("moremi room-user-image")).append($("<div>").addClass("room-user-stat").append(i=$("<div>").addClass("room-user-ready")).append(n=$("<div>").addClass("room-user-team team-"+a.game.team).html($("#team-"+a.game.team).html()))).append($("<div>").addClass("room-user-title").append(He(a.data.score).addClass("room-user-level")).append(d=$("<div>").addClass("room-user-name").html(a.profile.title||a.profile.name))).on("click",function(e){be($(e.currentTarget).attr("id").slice(10))})),gr(l,a.equip),b&&n.hide(),a.id==y.room.master?i.addClass("room-user-master").html(L.master+v+(b||"")):b?i.addClass("room-user-spectate").html(L.stat_spectate+v):a.game.ready||a.robot?(i.addClass("room-user-readied").html(L.stat_ready),a.robot||(f=!0)):a.game.practice?(i.addClass("room-user-practice").html(L.stat_practice),h=!1):(i.html(L.stat_noready),h=!1),ae(d,a)}f&&y.room.master==y.id&&h?y._jamsu||(y._jamsu=G(de,5e3)):(clearTimeout(y._jamsu),delete y._jamsu)}c.dialog.profile.is(":visible")&&be(y._profiled)}function de(){sr(L.subJamsu),y._jamsu=G(function(){P("leave"),alert(L.masterJamsu)},3e4)}function ce(e,r){var o;return(o=y["_s"+e])?(clearTimeout(o.timer),o.$obj=$("#game-user-"+e+" .game-user-score"),o.goal=r):o=y["_s"+e]={$obj:$("#game-user-"+e+" .game-user-score"),goal:r,now:0},me(o),$("#game-user-"+e)}function me(e){var r=(e.goal-e.now)*Math.min(1,.01*f);r<.1?r=e.goal-e.now:e.timer=G(me,f,e),e.now+=r,function(e,r){var o,a=r>99999?M(Math.round(.001*r),4)+"k":M(r,5);for(e.empty(),o=0;o<a.length;o++)e.append($("<div>").addClass("game-user-score-char").html(a[o]))}(e.$obj,Math.round(e.now))}function ue(e){var r=$("#dress-view"),o=y.users[y.id];gr(r,o.equip),$(".dress-type.selected").removeClass("selected"),$("#dress-type-all").addClass("selected"),$("#dress-exordial").val(o.exordial),ge(e||!0)}function pe(e,r,o,a,t){var i,s,n,l,d,c,m=[],u=!0===o;for(c in e.empty(),a||(a={}),a)y.box.hasOwnProperty(a[c])||(y.box[a[c]]={value:0});for(c in y.box)m.push({key:c,obj:lr(c),value:y.box[c]});for(c in m.sort(function(e,r){return e.obj.name<r.obj.name?-1:1}),m)s=m[c].obj,n=m[c].value,"BDG"==(l=s.group).substr(0,3)&&(l="BDG"),d="Mhand"==l?a.Mlhand==m[c].key||a.Mrhand==m[c].key:a[l]==m[c].key,"number"==typeof n&&(n={value:n}),(n.hasOwnProperty("value")||d)&&(u||-1!=o.indexOf(s.group))&&(e.append(i=$("<div>").addClass("dress-item").append(Ye(s.image).addClass("dress-item-image").html("x"+n.value)).append(Ee(s,d,n.expire))),i.attr("id",r+"-"+s._id).on("click",t),d&&i.addClass("dress-equipped"));global.expl(e)}function ge(e){var r,o=y.users[y.id].equip||{},a=!0===e;y._avGroup=e,r=!!a||(e||"").split(","),pe($("#dress-goods"),"dress",r,o,function(e){var r,o=$(e.currentTarget),a=o.attr("id").slice(6),i=lr(a);if(e.ctrlKey){if(o.hasClass("dress-equipped"))return hr(426);if(!confirm(L.surePayback+fr(Math.round(.2*(i.cost||0)))+L.ping))return;$.post("/payback/"+a,function(e){if(e.error)return hr(e.error);alert(L.painback),y.box=e.box,y.users[y.id].money=e.money,ue(y._avGroup),z(!1)})}else if(-1!=t.indexOf(i.group))"Mhand"==i.group&&(r=confirm(L.dressWhichHand)),function(e,r){var o=y.users[y.id],a=y.shop[e].group;"Mhand"==a&&(a=r?"Mlhand":"Mrhand");"BDG"==a.substr(0,3)&&(a="BDG");var t=o.equip[a]==e;confirm(L[t?"sureUnequip":"sureEquip"]+": "+L[e][0])&&$.post("/equip/"+e,{isLeft:r},function(e){if(e.error)return hr(e.error);y.box=e.box,o.equip=e.equip,ue(y._avGroup),P("refresh"),z(!1)})}(a,r);else if("CNS"==i.group){if(!confirm(L.sureConsume))return;$.post("/consume/"+a,function(e){e.exp&&sr(L.obtainExp+": "+fr(e.exp)),e.money&&sr(L.obtainMoney+": "+fr(e.money)),e.gain.forEach(function(e){ur(e)}),y.box=e.box,y.users[y.id].data=e.data,P("refresh"),ue(y._avGroup),Z()})}})}function fe(){var e=$("#cf-tray"),r=$("#cf-dict"),o=$("#cf-reward"),a=$("#cf-goods"),t=$("#cf-cost");function i(){e.html($("<h4>").css("padding-top","8px").width("100%").html(L.cfTray))}function s(){var a,s={WPC:1,WPB:2,WPA:3},l="",d=0;e.empty(),$(".cf-tray-selected").removeClass("cf-tray-selected"),y._tray.forEach(function(r){a=lr(r),l+=r.slice(4),d+=s[r.slice(1,4)],e.append($("<div>").addClass("jt-image").css("background-image","url("+a.image+")").attr("id","cf-tray-"+r).on("click",n)),$("#cf-\\"+r).addClass("cf-tray-selected")}),r.html(L.searching),o.empty(),c.dialog.cfCompose.removeClass("cf-composable"),t.html(""),H(l,function(e){var a=!1;if(e.error){if(3!=l.length)return r.html(L["wpFail_"+e.error]);a=!0,r.html(L.cfBlend)}!function(e,r,a){$.get("/cf/"+e+"?l="+r+"&b="+(a?"1":""),function(e){if(e.error)return hr(e.error);o.empty(),e.data.forEach(function(e){var r=lr(e.key),a=e.rate>=1?L.cfRewAlways:(100*e.rate).toFixed(1)+"%";o.append($("<div>").addClass("cf-rew-item").append($("<div>").addClass("jt-image cf-rew-image").css("background-image","url("+r.image+")")).append($("<div>").width(100).append($("<div>").width(100).html(r.name)).append($("<div>").addClass("cf-rew-value").html("x"+e.value))).append($("<div>").addClass("cf-rew-rate").html(a)))}),t.html(L.cfCost+": "+e.cost+L.ping)})}(l,d,a),c.dialog.cfCompose.addClass("cf-composable"),e.error||r.html(Ue(e.word,e.mean,e.theme,e.type.split(",")))}),""==l&&i()}function n(e){var r=$(e.currentTarget).attr("id").slice(8),o=y._tray.indexOf(r);-1!=o&&(y._tray.splice(o,1),s())}y._tray=[],r.empty(),o.empty(),t.html(""),c.dialog.cfCompose.removeClass("cf-composable"),pe(a,"cf",["PIX","PIY","PIZ"],null,function(e){var r,o=$(e.currentTarget).attr("id").slice(3),a=y.box[o],t=0;if(y._tray.length>=6)return hr(435);for(r in y._tray)y._tray[r]==o&&t++;a-t>0?(y._tray.push(o),s()):hr(434)}),i()}function he(e){var r=c.dialog.lbTable.empty(),o=e.data[0]?e.data[0].rank:0,a=(e.page||Math.floor(o/20))+1;e.data.forEach(function(e,o){var a=y.users[e.id];a=a?a.profile.title||a.profile.name:L.hidden,e.score=Number(e.score),r.append($("<tr>").attr("id","ranking-"+e.id).addClass("ranking-"+(e.rank+1)).append($("<td>").html(e.rank+1)).append($("<td>").append(He(e.score).addClass("ranking-image")).append($("<label>").css("padding-top",2).html(We(e.score)))).append($("<td>").html(a)).append($("<td>").html(fr(e.score))))}),$("#ranking-"+y.id).addClass("ranking-me"),c.dialog.lbPage.html(L.page+" "+a),c.dialog.lbPrev.attr("disabled",a<=1),c.dialog.lbNext.attr("disabled",e.data.length<15),c.dialog.lbMe.attr("disabled",!!y.guest),y._lbpage=a-1}function ve(){var e,r,o,a,t=0;for(e in c.dialog.commFriends.empty(),y.friends)t++,a=y.friends[e],r=y._friends[e]||{},o=(y.users[e]||{}).profile,c.dialog.commFriends.append($("<div>").addClass("cf-item").attr("id","cfi-"+e).append($("<div>").addClass("cfi-status cfi-stat-"+(r.server?"on":"off"))).append($("<div>").addClass("cfi-server").html(r.server?L["server_"+r.server]:"-")).append($("<div>").addClass("cfi-name ellipse").html(o?o.title||o.name:L.hidden)).append($("<div>").addClass("cfi-memo ellipse").text(a)).append($("<div>").addClass("cfi-menu").append($("<i>").addClass("fa fa-pencil").on("click",i)).append($("<i>").addClass("fa fa-remove").on("click",s))));function i(e){var r=$(e.currentTarget).parent().parent().attr("id").slice(4),o=y.friends[r],a=prompt(L.friendEditMemo,o);a&&P("friendEdit",{id:r,memo:a},!0)}function s(e){var r=$(e.currentTarget).parent().parent().attr("id").slice(4),o=y.friends[r];if(y._friends[r].server)return hr(455);confirm(o+"(#"+r.substr(0,5)+")\n"+L.friendSureRemove)&&P("friendRemove",{id:r},!0)}$("#CommunityDiag .dialog-title").html(L.communityText+" ("+t+" / 100)")}function be(e){var r,o,a,t=y.users[e]||y.robots[e],i=$("#profile-record").empty();if(t){if($("#ProfileDiag .dialog-title").html((t.profile.title||t.profile.name)+L.sProfile),$(".profile-head").empty().append(r=$("<div>").addClass("moremi profile-moremi")).append($("<div>").addClass("profile-head-item").append(Ye(t.profile.image).addClass("profile-image")).append($("<div>").addClass("profile-title ellipse").html(t.profile.title||t.profile.name).append($("<label>").addClass("profile-tag").html(" #"+t.id.toString().substr(0,5))))).append($("<div>").addClass("profile-head-item").append(He(t.data.score).addClass("profile-level")).append($("<div>").addClass("profile-level-text").html(L.LEVEL+" "+(a=We(t.data.score)))).append($("<div>").addClass("profile-score-text").html(fr(t.data.score)+" / "+fr(h[a-1])+L.PTS))).append(o=$("<div>").addClass("profile-head-item profile-exordial ellipse").text(tr(t.exordial||"")).append($("<div>").addClass("expl").css({"white-space":"normal",width:300,"font-size":"11px"}).text(t.exordial))),t.robot)c.dialog.profileLevel.show(),c.dialog.profileLevel.prop("disabled",y.id!=y.room.master),$("#profile-place").html(y.room.id+L.roomNumber);else{for(a in c.dialog.profileLevel.hide(),$("#profile-place").html(t.place?t.place+L.roomNumber:L.lobby),t.data.record){var s=t.data.record[a];i.append($("<div>").addClass("profile-record-field").append($("<div>").addClass("profile-field-name").html(L["mode"+a])).append($("<div>").addClass("profile-field-record").html(s[0]+L.P+" "+s[1]+L.W)).append($("<div>").addClass("profile-field-score").html(fr(s[2])+L.PTS)))}gr(r,t.equip)}y._profiled=e,c.dialog.profileKick.hide(),c.dialog.profileShut.hide(),c.dialog.profileDress.hide(),c.dialog.profileWhisper.hide(),c.dialog.profileHandover.hide(),y.id==e?c.dialog.profileDress.show():t.robot||(c.dialog.profileShut.show(),c.dialog.profileWhisper.show()),y.room&&y.id!=e&&y.id==y.room.master&&(c.dialog.profileKick.show(),c.dialog.profileHandover.show()),N(c.dialog.profile),c.dialog.profile.show(),global.expl(o)}else sr(L.error_405)}function $e(e){var r;("AI"==e||(r=y.users[e].profile.title||y.users[e].profile.name,confirm(r+L.sureInvite)))&&P("invite",{target:e})}function ke(e){y._replay||y.lastFail!=y.id||y.id!=e?y.failCombo=0:(y.failCombo++,1==y.failCombo&&sr(L.trollWarning),y.failCombo>1&&(P("leave"),hr(437))),y.lastFail=e}function _e(){var e;for(e in y.room.players)(y._replay?m.users[y.room.players[e]]||y.room.players[e]:y.users[y.room.players[e]]||y.robots[y.room.players[e].id]).game.score=0,delete y["_s"+y.room.players[e]];delete y.lastFail,y.failCombo=0,y._spectate=-1==y.room.game.seq.indexOf(y.id),y._gAnim=!0,c.box.room.show().height(360).animate({height:1},500),c.box.game.height(1).animate({height:410},500),Ze(),c.dialog.resultSave.attr("disabled",!1),qe(),c.game.display.html(L.soon),er("game_start"),ar(),G(function(){c.box.room.height(360).hide(),c.chat.scrollTop(999999999)},500)}function ye(){var e;for(e in y.room.game.seq)y.room.game.seq[e].robot&&(y.room.game.seq[e].game.score=0);for(e in m.users={},m.players){var r=m.players[e].id,o=m.readies[r]||{},a=y.users[r]||y.robots[r],t=r;m.players[e].robot?(a=m.users[r]={robot:!0},(t=m.players[e]).game={}):a=m.users[r]={},y.room.players.push(t),a.id=t,a.profile=m.players[e],a.data=a.profile.data,a.equip=a.profile.equip,a.game={score:0,team:o.t}}y._rf=0}function we(e){var r,o,a=y.room.events[--y._rf];if(a){r=a.time;do{if(!(a=y.room.events[--y._rf]))break}while(r-a.time<1e3);for(o=y._rf-1,ye(),r=y.muteEff,y.muteEff=!0,i=0;i<o;i++)Te();$(".deltaScore").remove(),y.muteEff=r,Te()}}function Ce(e){var r=y._rpause=!y._rpause;$(e.target).html(r?L.replayResume:L.replayPause)}function Le(e){clearTimeout(y._rt),Te()}function xe(){y.$gpt.html(y._gpp+" ("+(.001*y._eventTime).toFixed(1)+L.SECOND+" / "+(.001*y._gtt).toFixed(1)+L.SECOND+")")}function Te(e){var r,o=y.room.events[y._rf];if(clearTimeout(y._rt),e||y._rf++,o){if(y._rpause)return y._rf--,y._rt=G(Te,100);(r=o.data).hint&&(r.hint={_id:r.hint}),"chat"==r.type&&(r.timestamp=m.time+o.time),U(r),y._eventTime=o.time,xe(),y.room.events.length>y._rf?y._rt=G(Te,y.room.events[y._rf].time-o.time):Se()}else Se()}function Se(){delete y.room,y._replay=!1,c.box.room.height(360),clearTimeout(y._rt),z(),Xe("lobby")}function je(e){if(!y._replay&&m){var r,o=e;if(e.hasOwnProperty("type")&&"room"!=e.type&&"obtain"!=e.type){for(r in e={},o)e[r]=o[r];e.profile&&(e.profile={id:e.profile.id,title:"#"+e.profile.id}),e.user&&(e.user={id:e.user.profile.id,profile:{id:e.user.profile.id,title:"#"+e.user.profile.id},data:{score:0},equip:{}}),m.events.push({data:e,time:(new Date).getTime()-m.time})}}}function qe(){y._relay=!1,E(),c.game.here.hide(),c.dialog.result.hide(),c.dialog.dress.hide(),c.dialog.charFactory.hide(),$(".jjoriping,.rounds,.game-body").removeClass("cw"),c.game.display.empty(),c.game.chain.hide(),c.game.hints.empty().hide(),c.game.cwcmd.hide(),c.game.bb.hide(),c.game.round.empty(),c.game.history.empty(),c.game.items.show().css("opacity",0),$(".jjo-turn-time .graph-bar").width(0).css({float:"","text-align":"","background-color":""}),$(".jjo-round-time .graph-bar").width(0).css({float:"","text-align":""}).removeClass("round-extreme"),$(".game-user-bomb").removeClass("game-user-bomb")}function Re(e){var r;for(c.game.round.empty(),r=0;r<y.room.round;r++)c.game.round.append($l=$("<label>").html(y.room.game.title[r])),r+1==e&&$l.addClass("rounds-current")}function De(){K("turnGoing")}function Ae(e){return y._replay?m.users[e].game.score:(y.users[e]||y.robots[e]).game.score}function Oe(e,r){y._replay?m.users[e].game.score+=r:(y.users[e]||y.robots[e]).game.score+=r}function Be(e,r){return e.append(r),G(function(){r.remove()},2e3),e}function Me(e){var a,t,s,n=$(".result-board").empty();if(y._resultPage=2,!e)return c.dialog.resultOK.trigger("click");for(i in e.list)r=e.list[i],o=y.users[r.id]||{profile:{title:L.hidden}},s=r.id==y.id,n.append(a=$("<div>").addClass("result-board-item").append($("<div>").addClass("result-board-rank").html(r.rank+1)).append(He(r.score).addClass("result-board-level")).append($("<div>").addClass("result-board-name").html(o.profile.title||o.profile.name)).append($("<div>").addClass("result-board-score").html(fr(r.score)+L.PTS)).append($("<div>").addClass("result-board-reward").html("")).append(t=$("<div>").addClass("result-board-lvup").css("display",s?"block":"none").append($("<i>").addClass("fa fa-arrow-up")).append($("<div>").html(e.prev-r.rank)))),s&&(e.prev-r.rank<=0&&t.hide(),a.addClass("result-board-me"))}function Pe(){$(".kick-vote-time .graph-bar").width(y.kickTime/y._kickTime*300),--y.kickTime>0?y._kickTimer=G(Pe,1e3):c.dialog.kickVoteY.trigger("click")}function Ee(e,r,o){var a,t,i=$("<div>").addClass("expl dress-expl").append($("<div>").addClass("dress-item-title").html(dr(e._id)+(r?L.equipped:""))).append($("<div>").addClass("dress-item-group").html(L["GROUP_"+e.group])).append($("<div>").addClass("dress-item-expl").html(cr(e._id))),s=$("<div>").addClass("dress-item-opts");for(a in e.term&&i.append($("<div>").addClass("dress-item-term").html(Math.floor(e.term/86400)+L.DATE+" "+L.ITEM_TERM)),o&&i.append($("<div>").addClass("dress-item-term").html(new Date(1e3*o).toLocaleString()+L.ITEM_TERMED)),e.options)if("gif"!=a){var n=a.charAt(0);t=e.options[a],"g"==n?t="+"+(100*t).toFixed(1)+"%p":"h"==n&&(t="+"+t),s.append($("<label>").addClass("item-opts-head").html(L["OPTS_"+a])).append($("<label>").addClass("item-opts-body").html(t)).append($("<br>"))}return t&&i.append(s),i}function Ne(e){var r;$.get("/shop",function(o){for(r in y.shop={},o.goods)y.shop[o.goods[r]._id]=o.goods[r];e&&e(o)})}function Fe(e){var r,o,a=$(e.currentTarget).attr("id").slice(6),t=y.shop[a],i=y.users[y.id],s=i.money,n=s-t.cost,l=L.surePurchase,d={};for(o in y.box&&y.box[a]&&(l=L.alreadyGot+" "+l),N(c.dialog.purchase,!0),$("#purchase-ping-before").html(fr(s)+L.ping),$("#purchase-ping-cost").html(fr(t.cost)+L.ping),$("#purchase-item-name").html(L[a][0]),r=$("#purchase-ping-after").html(fr(n)+L.ping),$("#purchase-item-desc").html(n<0?L.notEnoughMoney:l),i.equip)d[o]=i.equip[o];d["Mhand"==t.group?["Mlhand","Mrhand"][Math.floor(2*Math.random())]:t.group]=a,gr("#moremi-after",d),y._sgood=a,c.dialog.purchaseOK.attr("disabled",n<0),n<0?r.addClass("purchase-not-enough"):r.removeClass("purchase-not-enough")}function Ie(e){e<1||($("#Middle").css("padding-top",e),G(function(){$("#Middle").css("padding-top",0),G(Ie,50,.7*e)},50))}function Ge(r,o,a,t){var i,n,l,d,m,u=e[y.room.mode],g="KKT"==u,f="KAP"==u,h=p[i=r.length],v=0,b=y.turnTime/96,k=y.turnTime/12;if(c.game.display.empty(),h?(n="As"+y._speed,h=h.split("")):"en"==s[u].lang&&i<10?n="As"+y._speed:(n="Al",Ie(i)),l="K"+y._speed,h){for(d in h)"0"!=h[d]&&(c.game.display.append(m=$("<div>").addClass("display-text").css({float:f?"right":"left","margin-top":-6,"font-size":36}).hide().html(f?r.charAt(i-v-1):r.charAt(v))),v++,G(function(e,r){var o={"margin-top":0};er(r),e.html()==y.mission?(er("mission"),e.css({color:"#66FF66"}),o["font-size"]=24):o["font-size"]=20,e.show().animate(o,100)},Number(d)*b,m,n));d=c.game.display.children("div").get(0),$(d).css(f?"margin-right":"margin-left",.5*(c.game.display.width()-20*i))}else if(v="",f)for(d=0;d<i;d++)G(function(e){er(n),e==y.mission?(er("mission"),v="<label style='color: #66FF66;'>"+e+"</label>"+v):v=e+v,c.game.display.html(v)},Number(d)*k/i,r[i-d-1]);else for(d=0;d<i;d++)G(function(e){er(n),e==y.mission?(er("mission"),v+="<label style='color: #66FF66;'>"+e+"</label>"):v+=e,c.game.display.html(v)},Number(d)*k/i,r[d]);G(function(){for(d=0;d<3;d++)G(function(e){if(g){if(1==e)return;er("kung")}(h?c.game.display.children(".display-text"):c.game.display).css("font-size",21).animate({"font-size":20},b)},d*b*2,d);G(Ke,4*b,r,o,a,t),g||er(l)},k)}function Ke(e,r,o,a){var t,i,s,n=a?a.split(","):[],l={};c.game.history.prepend(t=$("<div>").addClass("ellipse history-item").width(0).animate({width:200}).html(e)),(i=c.game.history.children()).length>6&&i.last().remove(),s=Ue(e,r,o,n),n.forEach(function(e){l[e]||L["class_"+e]&&(l[e]=!0,t.append($("<label>").addClass("history-class").html(L["class_"+e])))}),t.append(i=$("<div>").addClass("history-mean ellipse").append(s)).append($("<div>").addClass("expl").css({width:200,"white-space":"normal"}).html("<h5 style='color: #BBBBBB;'>"+s.html()+"</h5>")),global.expl(t)}function Ue(e,r,o,a){if(!r||-1==r.indexOf("＂"))return t=r,$("<label>").addClass("word").html(t);var t,i=$("<label>").addClass("word"),s=r.split(/＂[0-9]+＂/).slice(1).map(function(e){return-1==e.indexOf("［")?[[e]]:e.split(/［[0-9]+］/).slice(1).map(function(e){return e.split(/（[0-9]+）/).slice(1)})}),n=(a&&a.map(function(e){return L["class_"+e]}),o?o.split(",").map(function(e){return L["theme_"+e]}):[]),l=s.length>1;return s.forEach(function(e,r){var o=$("<label>").addClass("word-m1"),a=e.length>1;l&&o.append($("<label>").addClass("word-head word-m1-head").html(r+1)),e.forEach(function(e,r){var t=$("<label>").addClass("word-m2"),i=e.length,s=i>1,l=n.splice(0,i);a&&t.append($("<label>").addClass("word-head word-m2-head").html(r+1)),e.forEach(function(e,r){var o=$("<label>").addClass("word-m3"),a=l.shift();s&&o.append($("<label>").addClass("word-head word-m3-head").html(r+1)),a&&o.append($("<label>").addClass("word-theme").html(a)),o.append($("<label>").addClass("word-m3-body").html(e.replace(/\$\$[^\$]+\$\$/g,function(e){var r=e.slice(2,e.length-2).replace(/\^\{([^\}]+)\}/g,"<sup>$1</sup>").replace(/_\{([^\}]+)\}/g,"<sub>$1</sub>").replace(/\\geq/g,"≥");return"<equ>"+r+"</equ>"}).replace(/\*\*([^\*]+)\*\*/g,"<sup>$1</sup>").replace(/\*([^\*]+)\*/g,"<sub>$1</sub>"))),t.append(o)}),o.append(t)}),i.append(o)}),i}function Je(e,r,o){var a=e+(r?"("+r+")":"");return o&&(a+="<label class='jjo-display-word-length'>("+o+")</label>"),a}function Ve(e){return Math.round((.3*!(e%5)+1)*(.4*!(e%15)+1)*(.5*!(e%45)+1)*(120+60*Math.floor(e/5)+120*Math.floor(e*e/225)+180*Math.floor(e*e/2025)))}function We(e){var r,o=h.length;for(r=0;r<o&&!(e<h[r]);r++);return r+1}function He(e){var r=We(e)-1,o=r%25*-100,a=-100*Math.floor(.04*r);return $("<div>").css({float:"left","background-image":"url('/img/kkutu/lv/newlv.png')","background-position":o+"% "+a+"%","background-size":"2560%"})}function Ye(e){return $("<div>").addClass("jt-image").css("background-image","url('"+e+"')")}function Qe(r,o,a){var t,i=[L["mode"+e[r]]];for(t in n)o[n[t].name.toLowerCase()]&&i.push(L["opt"+n[t].name]);return a&&i.push(o.injpick.join("|")),a?i.toString():i}function ze(r,o){var a,t=Qe(o.mode,o.opts),i=s[e[o.mode]];r.empty().append($("<h5>").addClass("room-head-number").html("["+(o.practice?L.practice:o.id)+"]")).append($("<h5>").addClass("room-head-title").text(tr(o.title))).append(a=$("<h5>").addClass("room-head-mode").html(t.join(" / "))).append($("<h5>").addClass("room-head-limit").html((u?"":L.players+" ")+o.players.length+" / "+o.limit)).append($("<h5>").addClass("room-head-round").html(L.rounds+" "+o.round)).append($("<h5>").addClass("room-head-time").html(o.time+L.SECOND)),-1!=i.opts.indexOf("ijp")&&(a.append($("<div>").addClass("expl").html("<h5>"+o.opts.injpick.map(function(e){return L["theme_"+e]})+"</h5>")),global.expl(r))}function Xe(e,r){return y.bgm&&y.bgm.stop(),y.bgm=er(e,!0)}function Ze(){y.bgm&&(y.bgm.stop(),delete y.bgm)}function er(e,r){var o,a,t=r&&y.muteBGM||!r&&y.muteEff;return a=k[e]||k.missing,window.hasOwnProperty("AudioBuffer")&&a instanceof AudioBuffer?((o=x.createBufferSource()).startedAt=x.currentTime,o.loop=r,o.buffer=t?x.createBuffer(2,a.length,x.sampleRate):a,o.connect(x.destination)):(a.readyState&&(a.audio.currentTime=0),a.audio.loop=r||!1,a.audio.volume=t?0:1,o=a),_[e]&&_[e].stop(),_[e]=o,o.key=e,o.start(),o}function rr(){var e;for(e in _)_[e].stop()}function or(e){var r;y.rooms[e]&&(y.rooms[e].password&&!(r=prompt(L.putPassword))||(y._pw=r,P("enter",{id:e,password:r})))}function ar(){var e=$("#Chat,#chat-log-board"),r=e.children(".chat-item").last().get(0);r&&"HR"==r.tagName||(e.append($("<hr>").addClass("chat-item")),c.chat.scrollTop(999999999))}function tr(e){return e.replace(v,"♥♥")}function ir(e,r,o,a){var t,i,s,n,l=a?new Date(a):new Date,d=y.users[e.id]?y.users[e.id].equip:{};if(!y._shut[e.title||e.name]){if(o){if(y.opts.dw)return;if(y._wblock[o])return}r=tr(r),er("k"),nr(),!u&&y.room&&(t=(y.room.gaming?2:0)+($(".jjoriping").hasClass("cw")?1:0),function(e,r,o){$("#cb-"+r).remove();var a,t,i=(2&o?$("#game-user-"+r):$("#room-user-"+r)).offset(),s=2==o?"chat-balloon-bot":"chat-balloon-tip",n=$("<div>").addClass("chat-balloon").attr("id","cb-"+r).append($("<div>").addClass("jt-image "+s))[2==o?"prepend":"append"]($("<h4>").text(e));i&&(c.balloons.append(n),1==o?(a=0,t=220):2==o?(a=35-n.height(),t=-2):3==o?(a=5,t=210):(a=40,t=110),n.css({top:i.top+a,left:i.left+t}),G(function(){n.animate({opacity:0},500,function(){n.remove()})},2500))}(r,e.id,t)),c.chat.append(s=$("<div>").addClass("chat-item").append(t=$("<div>").addClass("chat-head ellipse").text(e.title||e.name)).append(i=$("<div>").addClass("chat-body").text(r)).append($("<div>").addClass("chat-stamp").text(l.toLocaleTimeString()))),a&&t.prepend($("<i>").addClass("fa fa-video-camera")),t.on("click",function(r){be(e.id)}),c.chatLog.append(s=s.clone()),s.append($("<div>").addClass("expl").css("font-weight","normal").html("#"+(e.id||"").substr(0,5))),(n=r.match(/https?:\/\/[\w\.\?\/&#%=-_\+]+/g))&&(r=i.html(),n.forEach(function(e){r=r.replace(e,"<a href='#' style='color: #2222FF;' onclick='if(confirm(\""+L.linkWarning+'")) window.open("'+e+"\");'>"+e+"</a>")}),i.html(r)),o&&(!0!==o&&(y._recentFrom=o),i.html("<label style='color: #7777FF; font-weight: bold;'>&lt;"+L.whisper+"&gt;</label>"+i.html())),ae(t,{equip:d}),c.chat.scrollTop(999999999)}}function sr(e,r){var o=new Date;er("k"),nr(),$("#Chat,#chat-log-board").append($("<div>").addClass("chat-item chat-notice").append($("<div>").addClass("chat-head").text(r||L.notice)).append($("<div>").addClass("chat-body").html(e)).append($("<div>").addClass("chat-stamp").text(o.toLocaleTimeString()))),c.chat.scrollTop(999999999),"tail"==r&&console.warn(o.toLocaleString(),e)}function nr(){var e=$("#Chat .chat-item"),r=$("#chat-log-board .chat-item");e.length>99&&e.first().remove(),r.length>199&&r.first().remove()}function lr(e){var r;return r="$"==e.charAt()?y.shop[e.slice(0,4)]:y.shop[e],{_id:e,group:r.group,term:r.term,name:dr(e),cost:r.cost,image:mr(e,r),desc:cr(e),options:r.options}}function dr(e){return"$"==e.charAt()?L[e.slice(0,4)][0]+" - "+e.slice(4):L[e][0]}function cr(e){return"$"==e.charAt()?L[e.slice(0,4)][1]:L[e][1]}function mr(e,r){var o,a;if(e){if("$"==e.charAt())return function(e,r){var o,a=document.createElement("canvas"),t=a.getContext("2d");switch(a.width=a.height=50,t.font="24px NBGothic",t.textAlign="center",t.textBaseline="middle",e){case"WPC":case"WPB":case"WPA":o=["WPC","WPB","WPA"].indexOf(e),t.beginPath(),t.arc(25,25,25,0,2*Math.PI),t.fillStyle=["#DDDDDD","#A6C5FF","#FFEF31"][o],t.fill(),t.fillStyle=["#000000","#4465C3","#E69D12"][o],t.fillText(r,25,25)}return a.toDataURL()}(e.slice(1,4),e.slice(4))}else"string"==typeof r&&(r={_id:"def",group:r,options:{}});return a=(o=y.shop[e]||r).options.hasOwnProperty("gif")?".gif":".png","BDG"==o.group.slice(0,3)?"/img/kkutu/moremi/badge/"+o._id+a:"M"==o.group.charAt(0)?"/img/kkutu/moremi/"+o.group.slice(1)+"/"+o._id+a:"/img/kkutu/shop/"+o._id+".png"}function ur(e){c.dialog.obtain.is(":visible")?y._obtain.push(e):(pr(e),N(c.dialog.obtain,!0))}function pr(e){er("success"),$("#obtain-image").css("background-image","url("+mr(e.key)+")"),$("#obtain-name").html(dr(e.key))}function gr(e,r){var o,t,i=$(e).empty(),s={Mlhand:"Mhand",Mrhand:"Mhand"};for(o in r||(r={}),a)t="M"+a[o],i.append($("<img>").addClass("moremies moremi-"+t.slice(1)).attr("src",mr(r[t],s[t]||t)).css({width:"100%",height:"100%"}));(t=r.BDG)&&i.append($("<img>").addClass("moremies moremi-badge").attr("src",mr(t)).css({width:"100%",height:"100%"})),i.children(".moremi-back").after($("<img>").addClass("moremies moremi-body").attr("src",r.robot?"/img/kkutu/moremi/robot.png":"/img/kkutu/moremi/body.png").css({width:"100%",height:"100%"})),i.children(".moremi-rhand").css("transform","scaleX(-1)")}function fr(e){var r=/(^[+-]?\d+)(\d{3})/;if(null===e)return"?";for(e=e.toString();r.test(e);)e=e.replace(r,"$1,$2");return e}function hr(e){return alert(L["error_"+e])}function vr(e){c.yell.show().css("opacity",1).html(e),G(function(){c.yell.animate({opacity:0},3e3),G(function(){c.yell.hide()},3e3)},1e3)}delete window.WebSocket,delete window.setInterval})();